<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0F766E" />
  <title>Travel Plan</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    /* ===== Material-ish (no library) ===== */
    :root{
      --primary:#0F766E;
      --primary-2:#0b5e57;
      --surface:#ffffff;
      --surface-2:#f5f7f8;
      --outline:#e3e7ea;
      --text:#0b1220;
      --muted:#5b6472;
      --shadow: 0 10px 24px rgba(0,0,0,.10);
      --shadow-2: 0 6px 14px rgba(0,0,0,.12);
      --radius:18px;
      --radius-sm:14px;
      --chip:#eef3f2;
      --danger:#b42318;
      --ok:#067647;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial;
      background: var(--surface-2);
      color: var(--text);
    }
    .app{
      max-width: 860px;
      margin: 0 auto;
      min-height: 100vh;
      padding-bottom: 28px;
    }
    .topbar{
      background: var(--primary);
      color: #fff;
      padding: 18px 16px 14px;
      position: sticky;
      top:0;
      z-index: 5;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
    }
    .toprow{
      display:flex; align-items:center; gap:12px;
    }
    .iconbtn{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      cursor:pointer;
      user-select:none;
    }
    .titlewrap{flex:1; min-width:0}
    .title{
      font-size: 22px; font-weight: 800; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .subtitle{
      font-size: 13px; opacity:.9; margin-top: 4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .segbar{
      margin-top: 12px;
      display:flex; gap:10px;
      overflow:auto;
      padding-bottom: 2px;
    }
    .daypill{
      flex:0 0 auto;
      min-width: 84px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .daypill .d{font-size:12px; opacity:.9}
    .daypill .n{font-size:18px; font-weight:900; margin-top:2px}
    .daypill.active{
      background:#fff;
      color: var(--primary);
      border-color: rgba(255,255,255,.85);
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }

    .content{padding: 14px 14px 0}

    .card{
      background: var(--surface);
      border:1px solid var(--outline);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
    }
    .cardhead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: 10px;
    }
    .cardtitle{
      font-size: 16px; font-weight: 800;
      display:flex; align-items:center; gap:10px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      cursor:pointer; user-select:none;
      border:1px solid var(--outline);
      background: #fff;
      color: var(--text);
      font-weight: 700;
    }
    .btn.primary{
      background: var(--primary);
      color:#fff;
      border-color: rgba(255,255,255,.0);
      box-shadow: var(--shadow-2);
    }
    .btn.tonal{
      background: rgba(15,118,110,.10);
      color: var(--primary);
      border-color: rgba(15,118,110,.18);
    }
    .btn.danger{
      background: rgba(180,35,24,.08);
      color: var(--danger);
      border-color: rgba(180,35,24,.18);
    }
    .btn.small{height:36px; padding:0 12px; border-radius: 12px; font-size: 13px;}
    .btn:active{transform: translateY(1px)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1; min-width: 180px}
    label{display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--outline);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    textarea{min-height: 92px; resize: vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(15,118,110,.55);
      box-shadow: 0 0 0 4px rgba(15,118,110,.12);
    }

    /* Chips */
    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      padding: 9px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--outline);
      font-weight: 700;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .chip.active{
      background: rgba(15,118,110,.12);
      border-color: rgba(15,118,110,.26);
      color: var(--primary);
    }

    /* Itinerary item */
    .it{
      border:1px solid var(--outline);
      border-radius: var(--radius);
      padding: 12px;
      background: #fff;
      margin-top: 10px;
    }
    .itTop{
      display:flex; gap:12px; align-items:flex-start;
    }
    .timebox{
      width: 86px; flex:0 0 auto;
      border-radius: 14px;
      border:1px solid var(--outline);
      padding: 10px 10px 8px;
      text-align:center;
      background: var(--surface-2);
    }
    .timebox .t{font-size: 22px; font-weight: 900; letter-spacing:.5px}
    .timebox .edit{font-size: 12px; color: var(--muted); margin-top: 2px}
    .itMain{flex:1; min-width:0}
    .itTitle{
      font-weight: 900; font-size: 16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .itSub{
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--outline);
      background: var(--surface-2);
      font-weight: 800;
      font-size: 12px;
      color: var(--muted);
      flex:0 0 auto;
    }
    .badge.ok{color: var(--ok); border-color: rgba(6,118,71,.24); background: rgba(6,118,71,.08)}
    .itActions{display:flex; gap:10px; align-items:center}
    .tinyIcon{
      width:40px; height:40px; border-radius: 14px;
      border:1px solid var(--outline);
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .itMeta{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .metaPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--outline);
      background: #fff;
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
    }
    .metaPill.muted{background: var(--surface-2); color: var(--muted)}
    .switch{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--outline);
      background:#fff;
      font-weight: 800;
      font-size: 13px;
    }
    .switch input{width:auto}
    .routebar{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .routechip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--surface-2);
      border: 1px solid var(--outline);
      font-weight: 900;
      font-size: 13px;
      color: var(--text);
    }
    .routechip b{font-weight: 900}
    .hr{height:1px; background: var(--outline); margin: 12px 0}

    /* Tabs (Itinerary/Translate/Expense) */
    .tabrow{
      display:flex; gap:10px;
    }
    .tabbtn{
      flex:1;
      height: 44px;
      border-radius: 14px;
      border:1px solid var(--outline);
      background:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    .tabbtn.active{
      background: rgba(15,118,110,.12);
      border-color: rgba(15,118,110,.26);
      color: var(--primary);
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 30;
      padding: 14px;
    }
    .backdrop.show{display:flex}
    .sheet{
      width:100%;
      max-width: 860px;
      background:#fff;
      border-radius: 22px;
      border:1px solid var(--outline);
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      padding: 14px;
      max-height: 88vh;
      overflow:auto;
    }
    .sheetHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px}
    .sheetTitle{font-weight: 900; font-size: 16px}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 16px;
      background:#111827;
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      display:none;
      z-index: 40;
      max-width: calc(100% - 28px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show{display:block}
    .hint{font-size:12px; color: var(--muted); margin-top: 8px; line-height:1.4}
  </style>
</head>

<body>
<div class="app">

  <!-- Top -->
  <div class="topbar">
    <div class="toprow">
      <div class="iconbtn" id="btnReset" title="æ–°è¡Œç¨‹ / é‡ç½®">â†º</div>
      <div class="titlewrap">
        <div class="title" id="appTitle">Travel Plan</div>
        <div class="subtitle" id="appSubtitle">å°šæœªå»ºç«‹è¡Œç¨‹</div>
      </div>
      <div class="iconbtn" id="btnTabPlan" title="è¡Œç¨‹">ğŸ“…</div>
      <div class="iconbtn" id="btnTabTranslate" title="ç¿»è­¯">ğŸŒ</div>
      <div class="iconbtn" id="btnTabMoney" title="èŠ±è²»">ğŸ’²</div>
    </div>
    <div class="segbar" id="dayBar"></div>
  </div>

  <div class="content">

    <!-- Main Tabs -->
    <div class="card">
      <div class="cardhead">
        <div class="cardtitle">åŠŸèƒ½</div>
        <div class="tabrow" style="width: 340px; max-width: 100%;">
          <button class="tabbtn active" id="tabPlan">è¡Œç¨‹</button>
          <button class="tabbtn" id="tabTranslate">ç¿»è­¯</button>
          <button class="tabbtn" id="tabMoney">èŠ±è²»</button>
        </div>
      </div>
      <div class="hint" id="pwaHint">PWA / Offline-firstï¼ˆé¦–æ¬¡å•Ÿå‹•æœƒå…ˆé€²å…¥ã€Œå»ºç«‹è¡Œç¨‹ã€åš®å°ï¼‰</div>
    </div>

    <!-- PLAN -->
    <div id="viewPlan">
      <div class="card">
        <div class="cardhead">
          <div class="cardtitle">è¡Œç¨‹</div>
          <button class="btn primary" id="btnAddItem">ï¼‹ æ–°å¢è¡Œç¨‹</button>
        </div>

        <div class="row" style="align-items:center">
          <div class="col">
            <div class="switch">
              <input type="checkbox" id="toggleAutoPush" />
              <span>è‡ªå‹•æ¨ç§»æ™‚é–“ï¼ˆå»ºè­°é–‹å•Ÿï¼‰</span>
            </div>
            <div class="hint">é–‹å•Ÿå¾Œï¼šä½ æ”¹ã€Œåœç•™/äº¤é€šã€æœƒè‡ªå‹•æŠŠä¸‹ä¸€å€‹æ™‚é–“å¾€å¾Œæ¨ï¼›è‹¥æŸä¸€ç­†éœ€è¦å›ºå®šæ™‚é–“ï¼Œè«‹ç”¨ã€Œé–å®šã€</div>
          </div>
          <div class="col">
            <div class="switch">
              <input type="checkbox" id="toggleShowRoutes" checked />
              <span>é¡¯ç¤ºè·¯ç·šæ™‚é–“</span>
            </div>
            <div class="hint">æ­¥è¡Œ/é–‹è»Š/å¤§çœ¾ï¼šä»¥åº§æ¨™è·é›¢ä¼°ç®—ï¼ˆå…é‡‘é‘°ï¼‰ã€‚ä¹Ÿæä¾›ä¸€éµæ‰“é–‹ Google Mapsã€‚</div>
          </div>
        </div>

        <div class="hr"></div>
        <div id="itList"></div>

        <div class="hint" id="emptyHint">ä»Šå¤©å°šç„¡è¡Œç¨‹ï¼ŒæŒ‰ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹ã€‚</div>
      </div>
    </div>

    <!-- TRANSLATE -->
    <div id="viewTranslate" style="display:none">
      <div class="card">
        <div class="cardhead">
          <div class="cardtitle">Google ç¿»è­¯ï¼ˆå…é‡‘é‘°ï¼‰</div>
          <button class="btn tonal" id="btnSwapLang">â‡„ äº¤æ›</button>
        </div>

        <div class="row">
          <div class="col">
            <label>ä¾†æºèªè¨€</label>
            <select id="sl">
              <option value="auto">è‡ªå‹•åµæ¸¬</option>
              <option value="zh-TW" selected>ç¹ä¸­</option>
              <option value="en">è‹±æ–‡</option>
              <option value="ja">æ—¥æ–‡</option>
              <option value="ko">éŸ“æ–‡</option>
              <option value="th">æ³°æ–‡</option>
              <option value="vi">è¶Šå—æ–‡</option>
            </select>
          </div>
          <div class="col">
            <label>ç›®æ¨™èªè¨€</label>
            <select id="tl">
              <option value="en">è‹±æ–‡</option>
              <option value="ja">æ—¥æ–‡</option>
              <option value="ko">éŸ“æ–‡</option>
              <option value="th" selected>æ³°æ–‡</option>
              <option value="vi">è¶Šå—æ–‡</option>
              <option value="zh-TW">ç¹ä¸­</option>
            </select>
          </div>
        </div>

        <label>è¼¸å…¥æ–‡å­—</label>
        <textarea id="trText" placeholder="è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—..."></textarea>

        <div class="chips" style="margin-top:10px">
          <div class="chip" data-p="è«‹å•é€™è£¡æ€éº¼å»ï¼Ÿ">è«‹å•é€™è£¡æ€éº¼å»ï¼Ÿ</div>
          <div class="chip" data-p="æˆ‘è¦é»é¤ï¼Œè¬è¬ã€‚">æˆ‘è¦é»é¤ï¼Œè¬è¬ã€‚</div>
          <div class="chip" data-p="å¯ä»¥åˆ·å¡å—ï¼Ÿ">å¯ä»¥åˆ·å¡å—ï¼Ÿ</div>
          <div class="chip" data-p="é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ">é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ</div>
          <div class="chip" data-p="æˆ‘æƒ³è¦ä¸€ä»½ä¸è¾£ã€‚">æˆ‘æƒ³è¦ä¸€ä»½ä¸è¾£ã€‚</div>
          <div class="chip" data-p="è«‹å¹«æˆ‘å«è¨ˆç¨‹è»Šã€‚">è«‹å¹«æˆ‘å«è¨ˆç¨‹è»Šã€‚</div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <button class="btn primary" id="btnOpenGoogleTr">â†— ç”¨ Google ç¿»è­¯é–‹å•Ÿ</button>
            <div class="hint">ä¸åƒ APIã€ä¸ç”¨é‡‘é‘°ï¼Œç›´æ¥é–‹ Google Translate ç¶²é ä¸¦å¸¶å…¥æ–‡å­—ã€‚</div>
          </div>
          <div class="col">
            <button class="btn" id="btnCopyTr">â§‰ è¤‡è£½æ–‡å­—</button>
            <button class="btn danger" id="btnClearTr" style="margin-left:8px">âœ• æ¸…ç©º</button>
          </div>
        </div>

      </div>
    </div>

    <!-- MONEY -->
    <div id="viewMoney" style="display:none">
      <div class="card">
        <div class="cardhead">
          <div class="cardtitle">ç¸½æ”¯å‡º</div>
          <button class="btn tonal" id="btnRefreshFx">âŸ³ åˆ·æ–°åŒ¯ç‡</button>
        </div>

        <div class="row">
          <div class="col">
            <div class="hint" id="fxInfo">åŒ¯ç‡ï¼šæœªæ›´æ–°</div>
            <div style="font-size:46px; font-weight: 1000; letter-spacing: .5px" id="totalFx">0</div>
            <div style="font-size:18px; font-weight: 900; color: var(--muted)" id="totalTwd">â‰ˆ NT$ 0</div>
          </div>
          <div class="col">
            <label>æ–°å¢æ”¯å‡º</label>
            <div class="row">
              <div class="col" style="min-width: 150px">
                <select id="expDay"></select>
              </div>
              <div class="col">
                <input id="expItem" placeholder="é …ç›®ï¼ˆä¾‹å¦‚ï¼šæ™šé¤ï¼‰" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <input id="expAmt" inputmode="decimal" placeholder="é‡‘é¡ï¼ˆè¡Œç¨‹å¹£åˆ¥ï¼‰" />
              </div>
              <div class="col" style="display:flex; align-items:flex-end">
                <button class="btn primary" id="btnAddExp" style="width:100%">ï¼‹ åŠ å…¥</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="cardtitle" style="margin-bottom:8px">æ¯æ—¥æ”¯å‡º</div>
        <div id="dailyExp"></div>

        <div class="hr"></div>

        <div class="cardtitle" style="margin-bottom:8px">æ˜ç´°</div>
        <div id="expList"></div>
        <div class="hint" id="noExpHint">å°šç„¡æ”¯å‡ºã€‚</div>
      </div>
    </div>

  </div>
</div>

<!-- Setup / Add Item Sheet -->
<div class="backdrop" id="modal">
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div class="sheetTitle" id="sheetTitle">å»ºç«‹è¡Œç¨‹</div>
      <button class="btn small" id="btnCloseModal">é—œé–‰</button>
    </div>
    <div id="sheetBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  /* ========= Storage Keys ========= */
  const K = {
    setup: 'tp_setup_v2',
    days: 'tp_days_v2',
    exp: 'tp_exp_v2',
    fx: 'tp_fx_v2'
  };

  /* ========= Default Setup (only used if user confirms) ========= */
  const DEFAULT_SETUP = {
    tripName: 'Travel Plan',
    country: '',
    destination: '',
    startDate: '',
    endDate: '',
    currency: 'NZD'
  };

  /* ========= State ========= */
  let setup = loadJSON(K.setup, null);
  let days = loadJSON(K.days, null);       // [{dateISO, short, items:[]}]
  let exp = loadJSON(K.exp, []);           // [{id, dayIdx, item, amount}]
  let fx = loadJSON(K.fx, { rate: 0, lastDate: '' }); // currency->TWD
  let curDay = 0;
  let tab = 'plan';
  let autoPush = loadJSON('tp_autoPush', true);
  let showRoutes = loadJSON('tp_showRoutes', true);

  /* ========= DOM ========= */
  const el = (id) => document.getElementById(id);
  const toastEl = el('toast');
  const modal = el('modal');
  const sheetTitle = el('sheetTitle');
  const sheetBody = el('sheetBody');

  /* Top buttons */
  el('btnReset').onclick = () => openResetSheet();
  el('btnTabPlan').onclick = () => setTab('plan');
  el('btnTabTranslate').onclick = () => setTab('translate');
  el('btnTabMoney').onclick = () => setTab('money');

  /* Tabs */
  el('tabPlan').onclick = () => setTab('plan');
  el('tabTranslate').onclick = () => setTab('translate');
  el('tabMoney').onclick = () => setTab('money');

  el('btnAddItem').onclick = () => openAddItemSheet();
  el('btnCloseModal').onclick = closeModal;

  el('toggleAutoPush').checked = !!autoPush;
  el('toggleAutoPush').onchange = (e) => {
    autoPush = e.target.checked;
    saveJSON('tp_autoPush', autoPush);
    toast(autoPush ? 'å·²é–‹å•Ÿè‡ªå‹•æ¨ç§»' : 'å·²é—œé–‰è‡ªå‹•æ¨ç§»');
  };
  el('toggleShowRoutes').checked = !!showRoutes;
  el('toggleShowRoutes').onchange = (e) => {
    showRoutes = e.target.checked;
    saveJSON('tp_showRoutes', showRoutes);
    render();
  };

  /* Translate */
  document.querySelectorAll('.chip[data-p]').forEach(ch => {
    ch.onclick = () => {
      el('trText').value = ch.dataset.p || '';
      toast('å·²å¸¶å…¥å¸¸ç”¨å¥');
    };
  });
  el('btnSwapLang').onclick = () => {
    const a = el('sl').value, b = el('tl').value;
    el('sl').value = b; el('tl').value = a;
  };
  el('btnOpenGoogleTr').onclick = () => {
    const sl = el('sl').value;
    const tl = el('tl').value;
    const text = (el('trText').value || '').trim();
    if (!text) return toast('è«‹å…ˆè¼¸å…¥æ–‡å­—');
    const url = 'https://translate.google.com/?sl=' + encodeURIComponent(sl) +
                '&tl=' + encodeURIComponent(tl) +
                '&text=' + encodeURIComponent(text) + '&op=translate';
    window.open(url, '_blank');
  };
  el('btnCopyTr').onclick = async () => {
    const t = el('trText').value || '';
    if (!t) return toast('æ²’æœ‰æ–‡å­—å¯è¤‡è£½');
    try {
      await navigator.clipboard.writeText(t);
      toast('å·²è¤‡è£½');
    } catch {
      toast('è¤‡è£½å¤±æ•—ï¼ˆå¯é•·æŒ‰æ‰‹å‹•è¤‡è£½ï¼‰');
    }
  };
  el('btnClearTr').onclick = () => el('trText').value = '';

  /* Money */
  el('btnAddExp').onclick = () => {
    if (!ensureSetup()) return;
    const dayIdx = parseInt(el('expDay').value, 10);
    const item = (el('expItem').value || '').trim();
    const amount = Number(el('expAmt').value || 0);
    if (!item) return toast('è«‹è¼¸å…¥é …ç›®');
    if (!isFinite(amount) || amount <= 0) return toast('é‡‘é¡ä¸æ­£ç¢º');
    exp.unshift({ id: uid(), dayIdx, item, amount });
    saveJSON(K.exp, exp);
    el('expItem').value = '';
    el('expAmt').value = '';
    renderMoney();
    toast('å·²åŠ å…¥æ”¯å‡º');
  };
  el('btnRefreshFx').onclick = () => refreshFx(true);

  /* ========= Init ========= */
  registerSW();
  if (!ensureSetup()) {
    // first-run onboarding
    openSetupSheet();
  } else {
    // load / build days if missing
    if (!days || !Array.isArray(days) || days.length === 0) {
      buildDaysFromSetup();
      saveAll();
    }
    // daily FX refresh
    refreshFx(false);
    render();
  }

  /* ========= Functions ========= */
  function setTab(next){
    tab = next;
    el('tabPlan').classList.toggle('active', tab==='plan');
    el('tabTranslate').classList.toggle('active', tab==='translate');
    el('tabMoney').classList.toggle('active', tab==='money');
    el('viewPlan').style.display = tab==='plan' ? '' : 'none';
    el('viewTranslate').style.display = tab==='translate' ? '' : 'none';
    el('viewMoney').style.display = tab==='money' ? '' : 'none';

    if (tab==='money') renderMoney();
  }

  function ensureSetup(){
    return setup && setup.startDate && setup.endDate;
  }

  function openSetupSheet(){
    sheetTitle.textContent = 'å»ºç«‹è¡Œç¨‹ï¼ˆå…ˆé¸åœ‹å®¶ï¼‰';
    sheetBody.innerHTML = `
      <div class="hint">ä½ çœ‹åˆ°ã€Œç›´æ¥è·³åˆ°å·²ç¶“è¼¸å¥½åœ°é»/æ™‚é–“ã€é€šå¸¸æ˜¯å› ç‚ºæ‰‹æ©Ÿè¨˜ä½äº†ä¸Šæ¬¡è³‡æ–™ã€‚é€™è£¡æ”¹æˆï¼šé¦–æ¬¡å•Ÿå‹•å…ˆåšå»ºç«‹è¡Œç¨‹ã€‚</div>

      <label>è¡Œç¨‹åç¨±</label>
      <input id="s_tripName" placeholder="ä¾‹å¦‚ï¼šçš‡åé® / å¤§é˜ª / æ›¼è°·" value="${escapeHTML((setup?.tripName)||DEFAULT_SETUP.tripName)}"/>

      <label>åœ‹å®¶ï¼ˆå…ˆé¸ï¼‰</label>
      <select id="s_country">
        ${countryOptions(setup?.country || '')}
      </select>
      <div class="hint">ä½ æƒ³è¦ã€Œå…ˆé¸åœ‹å®¶ã€ï¼šå°±å¾é€™è£¡é–‹å§‹ã€‚ä¹‹å¾Œä½ å†è¼¸å…¥åŸå¸‚/æ™¯é»ï¼Œç¨‹å¼ä¹Ÿèƒ½ç”¨å®šä½çµæœè¼”åŠ©ã€‚</div>

      <label>ä¸»è¦åŸå¸‚ / åœ°å€ï¼ˆå¯å…ˆç©ºè‘—ï¼‰</label>
      <input id="s_dest" placeholder="ä¾‹å¦‚ï¼šQueenstown / Osaka / Bangkok" value="${escapeHTML((setup?.destination)||'')}"/>

      <div class="row">
        <div class="col">
          <label>é–‹å§‹æ—¥æœŸ</label>
          <input id="s_start" type="date" value="${escapeHTML((setup?.startDate)||'')}"/>
        </div>
        <div class="col">
          <label>çµæŸæ—¥æœŸ</label>
          <input id="s_end" type="date" value="${escapeHTML((setup?.endDate)||'')}"/>
        </div>
      </div>

      <label>å¹£åˆ¥</label>
      <select id="s_currency">
        ${currencyOptions(setup?.currency || guessCurrencyFromCountry(setup?.country || ''))}
      </select>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn primary" id="btnCreateTrip">å»ºç«‹è¡Œç¨‹</button>
        </div>
        <div class="col">
          <button class="btn danger" id="btnWipeAll">æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆå«å¿«å–æç¤ºï¼‰</button>
        </div>
      </div>

      <div class="hint">
        å…é‡‘é‘°å®šä½ï¼šOpenStreetMap Nominatimï¼›è·¯ç·šæ™‚é–“ï¼šä»¥åº§æ¨™è·é›¢ä¼°ç®—ï¼ˆæ­¥è¡Œ/é–‹è»Š/å¤§çœ¾ï¼‰ï¼Œä¸¦æä¾› Google Maps é–‹å•Ÿã€‚
      </div>
    `;
    openModal();

    el('btnCreateTrip').onclick = () => {
      const tripName = (el('s_tripName').value || '').trim() || 'Travel Plan';
      const country = el('s_country').value || '';
      const destination = (el('s_dest').value || '').trim();
      const startDate = el('s_start').value || '';
      const endDate = el('s_end').value || '';
      const currency = el('s_currency').value || 'NZD';
      if (!startDate || !endDate) return toast('è«‹é¸é–‹å§‹/çµæŸæ—¥æœŸ');
      if (endDate < startDate) return toast('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');

      setup = { tripName, country, destination, startDate, endDate, currency };
      buildDaysFromSetup(true);
      saveAll();
      closeModal();
      refreshFx(true);
      render();
      toast('è¡Œç¨‹å·²å»ºç«‹');
    };

    el('s_country').onchange = () => {
      const c = el('s_country').value;
      const guess = guessCurrencyFromCountry(c);
      const curSel = el('s_currency');
      if (guess && curSel && !setup?.currency) curSel.value = guess;
      // å³ä½¿å·²æœ‰è¨­å®šï¼Œä¹Ÿè·Ÿè‘—æ›´æ–°é è¨­ï¼ˆæ›´ç›´è¦ºï¼‰
      if (guess) curSel.value = guess;
    };

    el('btnWipeAll').onclick = () => openResetSheet(true);
  }

  function openResetSheet(fromSetup=false){
    sheetTitle.textContent = 'æ–°è¡Œç¨‹ / é‡ç½®';
    sheetBody.innerHTML = `
      <div class="hint">
        å¦‚æœä½ ç™¼ç¾ã€Œä¸€ç›´è¼‰å…¥èˆŠç•«é¢ã€æˆ–ã€Œè·³å›èˆŠè³‡æ–™ã€ï¼Œé€šå¸¸æ˜¯ SW å¿«å– + localStorageã€‚
        é€™è£¡ä¸€éµæ¸…æ‰æœ¬æ©Ÿè³‡æ–™ï¼Œå›åˆ°ã€Œå…ˆé¸åœ‹å®¶ã€ã€‚
      </div>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <button class="btn danger" id="btnResetHard">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™ï¼ˆè¡Œç¨‹/èŠ±è²»/è¨­å®šï¼‰</button>
          <div class="hint">æœƒæ¸… localStorageï¼ˆä¸æœƒå‹• GitHub ä¸Šçš„æª”æ¡ˆï¼‰ã€‚</div>
        </div>
        <div class="col">
          <button class="btn tonal" id="btnSWHelp">æˆ‘å·²æ¸…è³‡æ–™ï¼Œä½†ç•«é¢ä»èˆŠï¼ˆSW å¿«å–ï¼‰</button>
          <div class="hint">æœƒæ•™ä½ ç”¨ iPhone å¿«é€Ÿæ¸…æ‰æ­¤ç¶²ç«™è³‡æ–™ã€‚</div>
        </div>
      </div>
      <div class="hr"></div>
      <button class="btn" id="btnGoSetup">å›åˆ°å»ºç«‹è¡Œç¨‹ï¼ˆå…ˆé¸åœ‹å®¶ï¼‰</button>
    `;
    openModal();

    el('btnResetHard').onclick = async () => {
      // clear app data
      [K.setup, K.days, K.exp, K.fx, 'tp_autoPush', 'tp_showRoutes'].forEach(k => localStorage.removeItem(k));
      setup = null; days = null; exp = []; fx = {rate:0,lastDate:''}; curDay=0;
      toast('å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™');
      // try clear caches too
      try{
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }catch{}
      closeModal();
      openSetupSheet();
    };

    el('btnSWHelp').onclick = () => {
      toast('iPhoneï¼šè¨­å®šâ†’Safariâ†’é€²éšâ†’ç¶²ç«™è³‡æ–™â†’æœå°‹ f0620123-png.github.io â†’åˆªé™¤');
    };

    el('btnGoSetup').onclick = () => {
      closeModal();
      openSetupSheet();
    };

    if (!fromSetup) openModal();
  }

  function openAddItemSheet(){
    if (!ensureSetup()) return openSetupSheet();

    const d = days[curDay];
    sheetTitle.textContent = `æ–°å¢è¡Œç¨‹ï¼ˆD${curDay+1} ${d.short}ï¼‰`;
    sheetBody.innerHTML = `
      <label>é–‹å§‹æ™‚é–“ï¼ˆå¯å…ˆç©ºè‘—ï¼Œäº¤çµ¦è‡ªå‹•æ¨ç§»ï¼‰</label>
      <input id="i_time" placeholder="ä¾‹å¦‚ï¼š09:30" inputmode="numeric"/>

      <label>è¡Œç¨‹åç¨±</label>
      <input id="i_title" placeholder="ä¾‹å¦‚ï¼šç©ºä¸­çºœè»Š / åˆé¤ / Check in" />

      <label>åœ°é»ï¼ˆè¼¸å…¥åº—å/æ™¯é»ï¼ŒæŒ‰ã€Œå®šä½ã€ï¼‰</label>
      <div class="row">
        <div class="col">
          <input id="i_place" placeholder="ä¾‹å¦‚ï¼šFergburger / Blue Peaks Lodge" />
        </div>
        <div class="col" style="min-width:160px; display:flex; gap:10px; align-items:flex-end">
          <button class="btn tonal" id="btnGeocode">ğŸ“ å®šä½</button>
          <button class="btn" id="btnClearGeo">æ¸…é™¤å®šä½</button>
        </div>
      </div>
      <div id="geoResult" class="hint"></div>
      <div id="geoList"></div>

      <label>åˆ†é¡ï¼ˆè† å›Šé¸æ“‡ï¼‰</label>
      <div class="chips" id="catChips"></div>

      <div class="row">
        <div class="col">
          <label>åœç•™æ™‚é–“</label>
          <div class="row">
            <div class="col"><input id="i_stay_h" inputmode="numeric" placeholder="h" value="1"></div>
            <div class="col"><input id="i_stay_m" inputmode="numeric" placeholder="m" value="0"></div>
          </div>
        </div>
        <div class="col">
          <label>å‰å¾€ä¸‹ä¸€å€‹ï¼ˆäº¤é€šæ™‚é–“ï¼‰</label>
          <div class="row">
            <div class="col">
              <select id="i_mode">
                <option value="walk">æ­¥è¡Œ</option>
                <option value="drive">é–‹è»Š</option>
                <option value="transit">å¤§çœ¾</option>
              </select>
            </div>
            <div class="col"><input id="i_toNext" inputmode="numeric" placeholder="åˆ†é˜" value="20"></div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <div class="switch">
            <input type="checkbox" id="i_lock" />
            <span>é–å®šæ™‚é–“</span>
          </div>
          <div class="hint">æœ‰äº›è¡Œç¨‹ï¼ˆä¾‹å¦‚é ç´„ï¼‰ä¸å¸Œæœ›è¢«æ¨ç§»ï¼Œå°±æŠŠé€™ç­†é–å®šã€‚</div>
        </div>
        <div class="col" style="display:flex; align-items:flex-end">
          <button class="btn primary" id="btnSaveItem" style="width:100%">åŠ å…¥</button>
        </div>
      </div>
    `;
    openModal();

    // category chips
    const cats = [
      {key:'food', label:'ç¾é£Ÿ'},
      {key:'shop', label:'è³¼ç‰©'},
      {key:'stay', label:'ä½å®¿'},
      {key:'fun', label:'éŠæ¨‚'},
      {key:'transport', label:'äº¤é€š'},
      {key:'spot', label:'æ™¯é»'}
    ];
    const catWrap = el('catChips');
    let selCat = 'spot';
    catWrap.innerHTML = cats.map(c => `<div class="chip ${c.key===selCat?'active':''}" data-k="${c.key}">${c.label}</div>`).join('');
    catWrap.querySelectorAll('.chip').forEach(ch => {
      ch.onclick = () => {
        selCat = ch.dataset.k;
        catWrap.querySelectorAll('.chip').forEach(x => x.classList.toggle('active', x.dataset.k===selCat));
      };
    });

    // geocoding
    let pickedGeo = null;
    el('btnGeocode').onclick = async () => {
      const q = (el('i_place').value || '').trim();
      if (!q) return toast('è«‹å…ˆè¼¸å…¥åœ°é»');
      el('geoResult').textContent = 'æœå°‹ä¸­...';
      const list = await nominatimSearch(q);
      if (!list.length){
        el('geoResult').textContent = 'æ‰¾ä¸åˆ°çµæœï¼ˆå¯æ›è‹±æ–‡/æ›´å®Œæ•´åœ°å€ï¼‰';
        el('geoList').innerHTML = '';
        return;
      }
      el('geoResult').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å®šä½çµæœï¼š';
      el('geoList').innerHTML = list.map((p,idx)=>`
        <div class="it" style="margin-top:10px">
          <div class="itTitle">${escapeHTML(p.display_name.split(',')[0] || p.display_name)}</div>
          <div class="itSub">${escapeHTML(p.display_name)}</div>
          <div style="margin-top:10px; display:flex; gap:10px">
            <button class="btn tonal small" data-pick="${idx}">é¸é€™å€‹</button>
          </div>
        </div>
      `).join('');
      el('geoList').querySelectorAll('button[data-pick]').forEach(b=>{
        b.onclick = () => {
          const p = list[Number(b.dataset.pick)];
          pickedGeo = {
            lat: Number(p.lat),
            lon: Number(p.lon),
            display: p.display_name.split(',')[0] || p.display_name,
            full: p.display_name
          };
          el('geoResult').textContent = `å·²å®šä½ï¼š${pickedGeo.display}`;
          el('geoList').innerHTML = '';
          toast('å®šä½å®Œæˆ');
        };
      });
    };

    el('btnClearGeo').onclick = () => {
      pickedGeo = null;
      el('geoResult').textContent = '';
      el('geoList').innerHTML = '';
      toast('å·²æ¸…é™¤å®šä½');
    };

    el('btnSaveItem').onclick = () => {
      const time = normalizeTime(el('i_time').value || '');
      const title = (el('i_title').value || '').trim();
      const place = (el('i_place').value || '').trim();
      const stayMin = clampInt(el('i_stay_h').value,0,24)*60 + clampInt(el('i_stay_m').value,0,59);
      const toNextMin = clampInt(el('i_toNext').value,0,600);
      const mode = el('i_mode').value || 'walk';
      const locked = !!el('i_lock').checked;

      if (!title) return toast('è«‹è¼¸å…¥è¡Œç¨‹åç¨±');

      const item = {
        id: uid(),
        time: time || '',
        title,
        placeQuery: place,
        category: selCat,
        stayMin: isFinite(stayMin) ? stayMin : 0,
        toNext: { mode, min: isFinite(toNextMin)?toNextMin:0 },
        locked,
        geo: pickedGeo,
        route: { walkMin: null, driveMin: null, transitMin: null }
      };
      d.items.push(item);

      // sort by time if provided; otherwise keep order
      d.items = sortItems(d.items);

      // recalc
      if (autoPush) recomputeDay(curDay);
      computeRoutesForDay(curDay);

      saveAll();
      closeModal();
      renderPlan();
      toast('å·²åŠ å…¥è¡Œç¨‹');
    };
  }

  function render(){
    renderHeader();
    renderDayBar();
    renderPlan();
    renderMoney();
  }

  function renderHeader(){
    const title = ensureSetup() ? (setup.tripName || 'Travel Plan') : 'Travel Plan';
    el('appTitle').textContent = title;

    if (!ensureSetup()){
      el('appSubtitle').textContent = 'å°šæœªå»ºç«‹è¡Œç¨‹';
      return;
    }
    const range = `${setup.startDate} â€“ ${setup.endDate}ï¼ˆ${days.length} å¤©ï¼‰`;
    const dest = setup.destination ? ` / ${setup.destination}` : '';
    const country = setup.country ? ` / ${setup.country}` : '';
    el('appSubtitle').textContent = range + country + dest;
  }

  function renderDayBar(){
    const bar = el('dayBar');
    if (!ensureSetup() || !days?.length){
      bar.innerHTML = '';
      return;
    }
    bar.innerHTML = days.map((d, idx) => `
      <div class="daypill ${idx===curDay?'active':''}" data-i="${idx}">
        <div class="d">${d.short}</div>
        <div class="n">D${idx+1}</div>
      </div>
    `).join('');
    bar.querySelectorAll('.daypill').forEach(p=>{
      p.onclick = () => {
        curDay = Number(p.dataset.i);
        renderPlan();
        if (tab==='money') renderMoney();
      };
    });
  }

  function renderPlan(){
    if (tab!=='plan') return;

    const list = el('itList');
    const empty = el('emptyHint');

    if (!ensureSetup()){
      list.innerHTML = '';
      empty.style.display = '';
      empty.textContent = 'å°šæœªå»ºç«‹è¡Œç¨‹ï¼Œè«‹å…ˆæŒ‰å·¦ä¸Šè§’ â†º å»ºç«‹è¡Œç¨‹ã€‚';
      return;
    }

    const d = days[curDay];
    if (!d) return;

    const items = d.items || [];
    empty.style.display = items.length ? 'none' : '';
    list.innerHTML = items.map((it, idx) => renderItem(it, idx)).join('');

    // Bind actions
    items.forEach((it, idx) => {
      const base = `it_${it.id}`;
      const btnEditTime = el(base + '_editTime');
      const btnDel = el(base + '_del');
      const btnLock = el(base + '_lock');
      const btnStay = el(base + '_stay');
      const btnToNext = el(base + '_toNext');
      const btnMode = el(base + '_mode');
      const btnGeo = el(base + '_geo');
      const btnCat = el(base + '_cat');
      const btnGmaps = el(base + '_gmaps');

      if (btnEditTime) btnEditTime.onclick = () => openEditTime(it.id);
      if (btnDel) btnDel.onclick = () => removeItem(it.id);
      if (btnLock) btnLock.onchange = (e) => {
        it.locked = !!e.target.checked;
        saveAll();
        if (autoPush) recomputeDay(curDay);
        renderPlan();
      };
      if (btnStay) btnStay.onclick = () => openEditDuration(it.id, 'stay');
      if (btnToNext) btnToNext.onclick = () => openEditDuration(it.id, 'toNext');
      if (btnMode) btnMode.onclick = () => cycleMode(it.id);
      if (btnGeo) btnGeo.onclick = () => openGeoPicker(it.id);
      if (btnCat) btnCat.onclick = () => openCatPicker(it.id);

      if (btnGmaps) btnGmaps.onclick = () => openGoogleMapsToNext(idx);
    });
  }

  function renderItem(it, idx){
    const time = it.time || '--:--';
    const catLabel = catText(it.category);
    const hasGeo = !!(it.geo && isFinite(it.geo.lat) && isFinite(it.geo.lon));
    const geoText = hasGeo ? (it.geo.full || it.geo.display) : (it.placeQuery || 'åœ°é»ï¼ˆè¼¸å…¥åº—å/æ™¯é»ï¼Œæœƒè‡ªå‹•å®šä½ï¼‰');

    const route = it.route || {};
    const walk = route.walkMin ?? 'â€”';
    const drive = route.driveMin ?? 'â€”';
    const transit = route.transitMin ?? 'â€”';
    const showR = showRoutes && hasGeo;

    return `
      <div class="it">
        <div class="itTop">
          <div class="timebox">
            <div class="t">${escapeHTML(time)}</div>
            <div class="edit" id="it_${it.id}_editTime">ä¿®æ”¹</div>
          </div>

          <div class="itMain">
            <div style="display:flex; gap:10px; align-items:center">
              <div class="itTitle" title="${escapeHTML(it.title)}">${escapeHTML(it.title)}</div>
              <div class="badge ${hasGeo?'ok':''}">${hasGeo?'å·²å®šä½':'æœªå®šä½'}</div>
            </div>
            <div class="itSub" title="${escapeHTML(geoText)}">ğŸ“ ${escapeHTML(geoText)}</div>

            <div class="itMeta">
              <div class="metaPill muted" id="it_${it.id}_cat">ğŸ·ï¸ ${catLabel}</div>
              <div class="metaPill" id="it_${it.id}_stay">â³ åœç•™ ${minsToHM(it.stayMin||0)}</div>
              <div class="metaPill" id="it_${it.id}_toNext">ğŸš¶/ğŸš—/ğŸš‡ ${transLabel(it.toNext)} </div>
              <div class="metaPill" id="it_${it.id}_mode">ğŸ” ${modeLabel((it.toNext||{}).mode||'walk')}</div>

              <label class="switch" style="margin:0">
                <input type="checkbox" id="it_${it.id}_lock" ${it.locked?'checked':''}/>
                <span>é–å®š</span>
              </label>

              <button class="btn small tonal" id="it_${it.id}_geo">å®šä½</button>
            </div>

            ${showR ? `
              <div class="routebar">
                <div class="routechip">ğŸš¶ <b>${walk}</b> åˆ†</div>
                <div class="routechip">ğŸš— <b>${drive}</b> åˆ†</div>
                <div class="routechip">ğŸš‡ <b>${transit}</b> åˆ†</div>
                <button class="btn small" id="it_${it.id}_gmaps">Google Maps</button>
              </div>
            ` : ''}

          </div>

          <div class="itActions">
            <div class="tinyIcon" id="it_${it.id}_del" title="åˆªé™¤">ğŸ—‘ï¸</div>
          </div>
        </div>
      </div>
    `;
  }

  function openEditTime(itemId){
    const it = findItem(itemId);
    if (!it) return;
    sheetTitle.textContent = 'ä¿®æ”¹æ™‚é–“';
    sheetBody.innerHTML = `
      <label>é–‹å§‹æ™‚é–“</label>
      <input id="et" placeholder="ä¾‹å¦‚ï¼š09:30" value="${escapeHTML(it.time||'')}" />
      <div class="row" style="margin-top:12px">
        <div class="col"><button class="btn primary" id="btnOk">ç¢ºèª</button></div>
        <div class="col"><button class="btn danger" id="btnClear">æ¸…ç©ºæ™‚é–“</button></div>
      </div>
      <div class="hint">è‹¥é–‹å•Ÿã€Œè‡ªå‹•æ¨ç§»ã€ï¼Œä½ èª¿æ•´é€™ç­†æ™‚é–“å¾Œï¼Œå¾Œé¢æœƒä¾åºé‡ç®—ï¼ˆé™¤éå¾Œé¢çš„è¢«é–å®šï¼‰ã€‚</div>
    `;
    openModal();
    el('btnOk').onclick = () => {
      it.time = normalizeTime(el('et').value || '');
      days[curDay].items = sortItems(days[curDay].items);
      if (autoPush) recomputeDay(curDay);
      computeRoutesForDay(curDay);
      saveAll();
      closeModal();
      renderPlan();
      toast('å·²æ›´æ–°æ™‚é–“');
    };
    el('btnClear').onclick = () => {
      it.time = '';
      if (autoPush) recomputeDay(curDay);
      saveAll();
      closeModal();
      renderPlan();
      toast('å·²æ¸…ç©ºæ™‚é–“');
    };
  }

  function openEditDuration(itemId, kind){
    const it = findItem(itemId);
    if (!it) return;
    const title = kind==='stay' ? 'ä¿®æ”¹åœç•™æ™‚é–“' : 'ä¿®æ”¹äº¤é€šæ™‚é–“ï¼ˆåˆ°ä¸‹ä¸€å€‹ï¼‰';
    const curMin = kind==='stay' ? (it.stayMin||0) : ((it.toNext||{}).min||0);
    sheetTitle.textContent = title;

    sheetBody.innerHTML = `
      <label>åˆ†é˜</label>
      <input id="dur" inputmode="numeric" value="${escapeHTML(String(curMin))}" />
      <div class="row" style="margin-top:12px">
        <div class="col"><button class="btn primary" id="btnOk">ç¢ºèª</button></div>
        <div class="col"><button class="btn tonal" id="btnAuto">ç”¨ä¼°ç®—ï¼ˆè‹¥å·²å®šä½ï¼‰</button></div>
      </div>
      <div class="hint">é–‹å•Ÿã€Œè‡ªå‹•æ¨ç§»ã€æ™‚ï¼Œé€™å€‹å€¼æœƒå½±éŸ¿å¾Œé¢é–‹å§‹æ™‚é–“ã€‚</div>
    `;
    openModal();

    el('btnOk').onclick = () => {
      const v = clampInt(el('dur').value, 0, 1440);
      if (kind==='stay') it.stayMin = v;
      else it.toNext.min = v;

      if (autoPush) recomputeDay(curDay);
      computeRoutesForDay(curDay);
      saveAll();
      closeModal();
      renderPlan();
      toast('å·²æ›´æ–°');
    };

    el('btnAuto').onclick = () => {
      // if have next + geos, auto fill from route estimate (walk/drive/transit depends on mode)
      const d = days[curDay];
      const idx = d.items.findIndex(x=>x.id===itemId);
      if (idx<0 || idx===d.items.length-1) return toast('æ­¤ç­†æ²’æœ‰ä¸‹ä¸€å€‹è¡Œç¨‹å¯ä¼°ç®—');
      const a = d.items[idx], b = d.items[idx+1];
      if (!(a.geo && b.geo)) return toast('éœ€è¦å…©å€‹è¡Œç¨‹éƒ½å·²å®šä½');
      const est = estimateAllModes(a.geo, b.geo);
      const m = (a.toNext||{}).mode || 'walk';
      const min = m==='walk' ? est.walkMin : (m==='drive'?est.driveMin:est.transitMin);
      el('dur').value = String(min);
      toast('å·²å¸¶å…¥ä¼°ç®—åˆ†é˜');
    };
  }

  function cycleMode(itemId){
    const it = findItem(itemId);
    if (!it) return;
    const order = ['walk','drive','transit'];
    const cur = (it.toNext||{}).mode || 'walk';
    const next = order[(order.indexOf(cur)+1)%order.length];
    it.toNext.mode = next;

    // if have next coords, set to estimate automatically (nice UX)
    const d = days[curDay];
    const idx = d.items.findIndex(x=>x.id===itemId);
    if (idx>=0 && idx<d.items.length-1){
      const a = d.items[idx], b = d.items[idx+1];
      if (a.geo && b.geo){
        const est = estimateAllModes(a.geo, b.geo);
        it.toNext.min = next==='walk' ? est.walkMin : (next==='drive'?est.driveMin:est.transitMin);
      }
    }

    if (autoPush) recomputeDay(curDay);
    computeRoutesForDay(curDay);
    saveAll();
    renderPlan();
  }

  function openGoogleMapsToNext(idx){
    const d = days[curDay];
    if (!d?.items?.length) return;
    if (idx >= d.items.length-1) return toast('é€™æ˜¯æœ€å¾Œä¸€å€‹è¡Œç¨‹');
    const a = d.items[idx], b = d.items[idx+1];
    if (!(a.geo && b.geo)) return toast('éœ€è¦å…©ç­†éƒ½å·²å®šä½');
    const mode = (a.toNext||{}).mode || 'walk';
    // Google Maps travelmode: walking, driving, transit
    const tmode = mode==='walk' ? 'walking' : (mode==='drive' ? 'driving' : 'transit');
    const url = `https://www.google.com/maps/dir/?api=1&origin=${a.geo.lat},${a.geo.lon}&destination=${b.geo.lat},${b.geo.lon}&travelmode=${tmode}`;
    window.open(url, '_blank');
  }

  function openGeoPicker(itemId){
    const it = findItem(itemId);
    if (!it) return;
    sheetTitle.textContent = 'å®šä½ï¼ˆå…é‡‘é‘°ï¼‰';
    sheetBody.innerHTML = `
      <div class="hint">è¼¸å…¥åº—å/æ™¯é»ï¼Œä½¿ç”¨ OpenStreetMap Nominatim æœå°‹ã€‚</div>
      <label>åœ°é»æ–‡å­—</label>
      <input id="gq" placeholder="ä¾‹å¦‚ï¼šFergburger" value="${escapeHTML(it.placeQuery||'')}" />
      <div class="row" style="margin-top:12px">
        <div class="col"><button class="btn tonal" id="btnSearch">æœå°‹</button></div>
        <div class="col"><button class="btn danger" id="btnClear">æ¸…é™¤å®šä½</button></div>
      </div>
      <div id="gHint" class="hint" style="margin-top:10px"></div>
      <div id="gList"></div>
    `;
    openModal();

    el('btnSearch').onclick = async () => {
      const q = (el('gq').value || '').trim();
      it.placeQuery = q;
      if (!q) return toast('è«‹è¼¸å…¥åœ°é»');
      el('gHint').textContent = 'æœå°‹ä¸­...';
      const list = await nominatimSearch(q);
      if (!list.length){
        el('gHint').textContent = 'æ‰¾ä¸åˆ°çµæœï¼ˆå¯æ›è‹±æ–‡/æ›´å®Œæ•´åœ°å€ï¼‰';
        el('gList').innerHTML = '';
        return;
      }
      el('gHint').textContent = 'è«‹é¸æ“‡ï¼š';
      el('gList').innerHTML = list.map((p,idx)=>`
        <div class="it">
          <div class="itTitle">${escapeHTML(p.display_name.split(',')[0] || p.display_name)}</div>
          <div class="itSub">${escapeHTML(p.display_name)}</div>
          <div style="margin-top:10px"><button class="btn tonal small" data-p="${idx}">é¸é€™å€‹</button></div>
        </div>
      `).join('');
      el('gList').querySelectorAll('button[data-p]').forEach(b=>{
        b.onclick = () => {
          const p = list[Number(b.dataset.p)];
          it.geo = {
            lat: Number(p.lat), lon: Number(p.lon),
            display: p.display_name.split(',')[0] || p.display_name,
            full: p.display_name
          };
          computeRoutesForDay(curDay);
          saveAll();
          closeModal();
          renderPlan();
          toast('å®šä½å®Œæˆ');
        };
      });
    };

    el('btnClear').onclick = () => {
      it.geo = null;
      computeRoutesForDay(curDay);
      saveAll();
      closeModal();
      renderPlan();
      toast('å·²æ¸…é™¤å®šä½');
    };
  }

  function openCatPicker(itemId){
    const it = findItem(itemId);
    if (!it) return;
    const cats = [
      {key:'food', label:'ç¾é£Ÿ'},
      {key:'shop', label:'è³¼ç‰©'},
      {key:'stay', label:'ä½å®¿'},
      {key:'fun', label:'éŠæ¨‚'},
      {key:'transport', label:'äº¤é€š'},
      {key:'spot', label:'æ™¯é»'}
    ];
    sheetTitle.textContent = 'é¸æ“‡åˆ†é¡';
    sheetBody.innerHTML = `
      <div class="chips" id="cwrap">
        ${cats.map(c => `<div class="chip ${c.key===it.category?'active':''}" data-k="${c.key}">${c.label}</div>`).join('')}
      </div>
      <div class="hint" style="margin-top:10px">é»ä¸€ä¸‹å°±æœƒå¥—ç”¨ä¸¦å›åˆ°è¡Œç¨‹ã€‚</div>
    `;
    openModal();
    el('cwrap').querySelectorAll('.chip').forEach(ch=>{
      ch.onclick = () => {
        it.category = ch.dataset.k;
        saveAll();
        closeModal();
        renderPlan();
      };
    });
  }

  function removeItem(itemId){
    const d = days[curDay];
    const idx = d.items.findIndex(x=>x.id===itemId);
    if (idx<0) return;
    d.items.splice(idx,1);
    if (autoPush) recomputeDay(curDay);
    computeRoutesForDay(curDay);
    saveAll();
    renderPlan();
    toast('å·²åˆªé™¤');
  }

  function findItem(itemId){
    const d = days[curDay];
    return d?.items?.find(x=>x.id===itemId) || null;
  }

  function sortItems(items){
    // Items with time first by time, then those without time keep order at end
    const withT = items.filter(x=>normalizeTime(x.time||''));
    const noT = items.filter(x=>!normalizeTime(x.time||''));
    withT.sort((a,b)=> timeToMin(a.time)-timeToMin(b.time));
    return [...withT, ...noT];
  }

  function recomputeDay(dayIdx){
    const d = days[dayIdx];
    if (!d?.items?.length) return;

    // cursor = first known time, else 09:00
    let cursor = null;
    for (const it of d.items){
      if (normalizeTime(it.time||'')){
        cursor = timeToMin(it.time);
        break;
      }
    }
    if (cursor===null) cursor = 9*60;

    for (let i=0;i<d.items.length;i++){
      const it = d.items[i];
      const hasTime = normalizeTime(it.time||'');
      if (it.locked && hasTime){
        cursor = timeToMin(it.time);
      } else {
        it.time = minToTime(cursor);
      }

      // advance cursor by stay + travel-to-next (this item's toNext)
      const stay = clampInt(it.stayMin||0, 0, 1440);
      const travel = clampInt((it.toNext||{}).min||0, 0, 1440);
      cursor += stay + travel;
      if (cursor>=24*60) cursor = cursor % (24*60); // same-day view; cross-day handling can be added later
    }
  }

  function computeRoutesForDay(dayIdx){
    const d = days[dayIdx];
    if (!d?.items?.length) return;
    // compute per item to NEXT using coords (pure estimate)
    for (let i=0;i<d.items.length;i++){
      const a = d.items[i], b = d.items[i+1];
      if (!a) continue;
      if (a.geo && b && b.geo){
        const est = estimateAllModes(a.geo, b.geo);
        a.route = est;
      } else {
        a.route = { walkMin: null, driveMin: null, transitMin: null };
      }
    }
  }

  function estimateAllModes(aGeo, bGeo){
    const km = haversineKm(aGeo.lat, aGeo.lon, bGeo.lat, bGeo.lon);
    // assumptions (no-key, stable, fast):
    const walkMin = Math.max(1, Math.round((km/5)*60));          // 5 km/h
    const driveMin = Math.max(1, Math.round((km/30)*60));        // 30 km/h city avg
    const transitMin = Math.max(2, Math.round((km/20)*60) + 10); // 20 km/h + waiting
    return { walkMin, driveMin, transitMin };
  }

  async function nominatimSearch(q){
    try{
      // Nominatim usage policy: keep it light; this is user-triggered.
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1&accept-language=zh-TW&q=' + encodeURIComponent(q);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return [];
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }catch{
      return [];
    }
  }

  /* Money UI */
  function renderMoney(){
    if (tab!=='money') return;
    if (!ensureSetup()){
      el('fxInfo').textContent = 'å°šæœªå»ºç«‹è¡Œç¨‹';
      el('totalFx').textContent = '0';
      el('totalTwd').textContent = 'â‰ˆ NT$ 0';
      return;
    }

    // day options
    el('expDay').innerHTML = days.map((d,idx)=>`<option value="${idx}">D${idx+1}ï¼ˆ${d.short}ï¼‰</option>`).join('');

    const totals = calcDailyTotals();
    const total = totals.reduce((a,b)=>a+b,0);

    const cur = setup.currency || 'NZD';
    el('fxInfo').textContent = `åŒ¯ç‡ï¼ˆ${cur}â†’TWDï¼‰ï¼š${fx.rate ? fx.rate.toFixed(4) : 'æœªæ›´æ–°'} / æ›´æ–°ï¼š${fx.lastDate||'æœªæ›´æ–°'}`;
    el('totalFx').textContent = `${cur} ${formatNum(total)}`;
    el('totalTwd').textContent = `â‰ˆ NT$ ${formatNum(Math.round(total * (fx.rate||0)))}`;

    // daily list
    el('dailyExp').innerHTML = totals.map((amt,idx)=>`
      <div class="it" style="margin-top:10px">
        <div class="itTitle">D${idx+1}ï¼ˆ${days[idx].short}ï¼‰</div>
        <div class="itSub">${setup.currency} ${formatNum(amt)}</div>
      </div>
    `).join('');

    // detail list
    const list = el('expList');
    const hint = el('noExpHint');
    if (!exp.length){
      list.innerHTML = '';
      hint.style.display = '';
    } else {
      hint.style.display = 'none';
      list.innerHTML = exp.map(e=>`
        <div class="it" style="margin-top:10px">
          <div class="itTitle">${escapeHTML(e.item)}</div>
          <div class="itSub">D${(e.dayIdx??0)+1} Â· ${setup.currency} ${formatNum(Number(e.amount||0))}</div>
        </div>
      `).join('');
    }
  }

  function calcDailyTotals(){
    const totals = Array(days.length).fill(0);
    exp.forEach(e=>{
      const i = e.dayIdx ?? 0;
      if (i>=0 && i<totals.length) totals[i] += Number(e.amount||0);
    });
    return totals;
  }

  async function refreshFx(force){
    if (!ensureSetup()) return;
    const cur = setup.currency || 'NZD';
    const today = new Date().toISOString().slice(0,10);

    if (!force && fx.lastDate === today && fx.rate) {
      // once per day
      return;
    }

    // Use exchangerate.host (no key) - if blocked, user can still use manual rate
    try{
      const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(cur)}&symbols=TWD`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('fx');
      const data = await res.json();
      const rate = Number(data?.rates?.TWD || 0);
      if (!rate) throw new Error('fx');
      fx = { rate, lastDate: today };
      saveJSON(K.fx, fx);
      if (tab==='money') renderMoney();
      toast(force ? 'åŒ¯ç‡å·²æ›´æ–°' : 'åŒ¯ç‡æ¯æ—¥è‡ªå‹•æ›´æ–°å®Œæˆ');
    }catch{
      toast('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼ˆå¯èƒ½è¢«ç¶²è·¯é˜»æ“‹ï¼‰ï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½');
    }
  }

  /* Setup â†’ Days */
  function buildDaysFromSetup(resetItems=false){
    const start = setup.startDate;
    const end = setup.endDate;
    const arr = [];
    const s = new Date(start + 'T00:00:00');
    const e = new Date(end + 'T00:00:00');
    if (isNaN(s) || isNaN(e)) return;

    for (let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      const iso = d.toISOString().slice(0,10);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      arr.push({
        dateISO: iso,
        short: `${mm}/${dd}`,
        items: resetItems ? [] : (findOldItemsByDate(iso) || [])
      });
    }
    days = arr;
    curDay = 0;
  }

  function findOldItemsByDate(iso){
    // if you later extend to keep items when changing date range
    return null;
  }

  function saveAll(){
    saveJSON(K.setup, setup);
    saveJSON(K.days, days);
    saveJSON(K.exp, exp);
    saveJSON(K.fx, fx);
  }

  /* Modal helpers */
  function openModal(){ modal.classList.add('show'); }
  function closeModal(){ modal.classList.remove('show'); }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  /* SW */
  async function registerSW(){
    if (!('serviceWorker' in navigator)) return;
    try{
      await navigator.serviceWorker.register('./sw.js', { scope: './' });
      // no UI needed; keep silent
    }catch{}
  }

  /* Utils */
  function loadJSON(k, fallback){
    try{
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : fallback;
    }catch{
      return fallback;
    }
  }
  function saveJSON(k, v){
    try{ localStorage.setItem(k, JSON.stringify(v)); }catch{}
  }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function escapeHTML(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }
  function normalizeTime(s){
    s = String(s||'').trim();
    if (!s) return '';
    // allow 930 -> 09:30
    if (/^\d{3,4}$/.test(s)){
      const t = s.padStart(4,'0');
      s = t.slice(0,2)+':'+t.slice(2,4);
    }
    const m = s.match(/^([01]?\d|2[0-3]):([0-5]\d)$/);
    return m ? `${String(m[1]).padStart(2,'0')}:${m[2]}` : '';
  }
  function timeToMin(t){
    const nt = normalizeTime(t);
    if (!nt) return 0;
    const [h,m] = nt.split(':').map(Number);
    return h*60+m;
  }
  function minToTime(min){
    min = (min % (24*60) + (24*60)) % (24*60);
    const h = String(Math.floor(min/60)).padStart(2,'0');
    const m = String(min%60).padStart(2,'0');
    return `${h}:${m}`;
  }
  function minsToHM(min){
    min = clampInt(min,0,10000);
    const h = Math.floor(min/60);
    const m = min%60;
    if (h<=0) return `${m}m`;
    if (m<=0) return `${h}h`;
    return `${h}h ${String(m).padStart(2,'0')}m`;
  }
  function clampInt(v, a, b){
    const n = parseInt(v,10);
    if (!isFinite(n)) return a;
    return Math.min(b, Math.max(a, n));
  }
  function formatNum(n){
    return Number(n||0).toLocaleString();
  }
  function transLabel(toNext){
    const mode = (toNext||{}).mode || 'walk';
    const min = clampInt((toNext||{}).min||0,0,1440);
    const icon = mode==='walk'?'ğŸš¶':(mode==='drive'?'ğŸš—':'ğŸš‡');
    return `${icon} ${min} åˆ†`;
  }
  function modeLabel(m){
    return m==='walk'?'æ­¥è¡Œ':(m==='drive'?'é–‹è»Š':'å¤§çœ¾');
  }
  function catText(k){
    return k==='food'?'ç¾é£Ÿ':
           k==='shop'?'è³¼ç‰©':
           k==='stay'?'ä½å®¿':
           k==='fun'?'éŠæ¨‚':
           k==='transport'?'äº¤é€š':'æ™¯é»';
  }
  function currencyOptions(sel){
    const list = [
      ['TWD','å°å¹£'],['JPY','æ—¥å¹£'],['KRW','éŸ“å…ƒ'],['CNY','äººæ°‘å¹£'],['HKD','æ¸¯å¹£'],['THB','æ³°éŠ–'],
      ['SGD','æ–°å¹£'],['VND','è¶Šå—ç›¾'],['MYR','é¦¬å¹£'],['PHP','æŠ«ç´¢'],['IDR','å°å°¼ç›¾'],
      ['USD','ç¾é‡‘'],['CAD','åŠ å¹£'],['EUR','æ­å…ƒ'],['GBP','è‹±éŠ'],['CHF','ç‘å£«æ³•éƒ'],
      ['AUD','æ¾³å¹£'],['NZD','ç´å¹£']
    ];
    return list.map(([c,name]) => `<option value="${c}" ${c===sel?'selected':''}>${c} ${name}</option>`).join('');
  }
  function countryOptions(sel){
    const list = [
      ['','ï¼ˆå¯ç•¥éï¼‰'],
      ['New Zealand','ç´è¥¿è˜­'],['Japan','æ—¥æœ¬'],['Thailand','æ³°åœ‹'],['South Korea','éŸ“åœ‹'],
      ['Vietnam','è¶Šå—'],['Singapore','æ–°åŠ å¡'],['Malaysia','é¦¬ä¾†è¥¿äº'],['Philippines','è²å¾‹è³“'],
      ['Indonesia','å°å°¼'],['Australia','æ¾³æ´²'],['United States','ç¾åœ‹'],['Canada','åŠ æ‹¿å¤§'],
      ['United Kingdom','è‹±åœ‹'],['France','æ³•åœ‹'],['Germany','å¾·åœ‹'],['Switzerland','ç‘å£«'],
      ['China','ä¸­åœ‹'],['Hong Kong','é¦™æ¸¯'],['Taiwan','å°ç£']
    ];
    return list.map(([v,cn])=>`<option value="${escapeHTML(v)}" ${v===sel?'selected':''}>${escapeHTML(cn)}${v?`ï¼ˆ${escapeHTML(v)}ï¼‰`:''}</option>`).join('');
  }
  function guessCurrencyFromCountry(country){
    if (!country) return 'NZD';
    const map = {
      'New Zealand':'NZD',
      'Japan':'JPY',
      'Thailand':'THB',
      'South Korea':'KRW',
      'Vietnam':'VND',
      'Singapore':'SGD',
      'Malaysia':'MYR',
      'Philippines':'PHP',
      'Indonesia':'IDR',
      'Australia':'AUD',
      'United States':'USD',
      'Canada':'CAD',
      'United Kingdom':'GBP',
      'France':'EUR',
      'Germany':'EUR',
      'Switzerland':'CHF',
      'China':'CNY',
      'Hong Kong':'HKD',
      'Taiwan':'TWD'
    };
    return map[country] || 'USD';
  }

  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const toRad = (d)=>d*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }

})();
</script>
</body>
</html>