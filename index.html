<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0F766E" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Travel Plan PWA</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icon.png" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    :root{
      --md-primary:#0F766E;
      --md-on-primary:#ffffff;
      --md-surface:#ffffff;
      --md-surface-2:#F7F8FA;
      --md-on-surface:#0F172A;
      --md-muted:#64748B;
      --md-outline:#E2E8F0;
      --md-shadow:0 10px 25px rgba(2,6,23,.08);
      --md-radius:18px;
      --md-radius-sm:12px;
      --md-radius-lg:24px;
      --md-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--md-font);
      background:linear-gradient(180deg,#0F766E 0%,#0F766E 140px,#F1F5F9 140px,#F1F5F9 100%);
      color:var(--md-on-surface);
      -webkit-tap-highlight-color:transparent;
    }
    .app{
      width:100%; max-width:430px; margin:0 auto; min-height:100vh;
      display:flex; flex-direction:column;
      background:transparent;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      padding:12px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      color:var(--md-on-primary);
      background:rgba(15,118,110,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .topbar .left{display:flex; gap:10px; align-items:center; min-width:0;}
    .iconbtn{
      width:40px; height:40px; border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.08);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .titlewrap{min-width:0}
    .title{
      font-size:18px; font-weight:800; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:flex; align-items:center; gap:8px;
    }
    .subtitle{
      margin-top:2px;
      font-size:12px; opacity:.85; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      color:var(--md-on-surface);
      font-weight:700; font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.small{padding:6px 10px;font-size:11px}
    .chip.primary{
      background:rgba(255,255,255,.15);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
    }
    .chip.ghost{
      background:transparent;
      border:1px dashed var(--md-outline);
      color:var(--md-muted);
      font-weight:800;
    }
    .seg{
      display:flex; gap:8px;
      background:rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.18);
      padding:6px; border-radius:16px;
    }
    .seg button{
      border:none; background:transparent; color:rgba(255,255,255,.78);
      width:42px; height:38px; border-radius:12px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .seg button.active{
      background:#fff; color:var(--md-primary);
      box-shadow:0 8px 18px rgba(2,6,23,.15);
      font-weight:900;
    }

    .daysbar{
      padding:10px 14px 12px;
      display:flex; gap:10px; overflow:auto;
      background:rgba(15,118,110,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .daypill{
      flex:0 0 auto;
      width:74px; height:62px;
      border-radius:18px;
      border:2px solid transparent;
      background:rgba(255,255,255,.14);
      color:#fff;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      cursor:pointer;
    }
    .daypill .d{font-size:12px; opacity:.86; font-weight:700;}
    .daypill .n{font-size:16px; font-weight:900; margin-top:2px;}
    .daypill.active{
      background:#fff;
      color:var(--md-primary);
      border-color:#fff;
      box-shadow:0 12px 24px rgba(2,6,23,.18);
      transform: translateY(1px);
    }

    .content{
      padding:14px;
      padding-bottom:90px;
    }

    .card{
      background:var(--md-surface);
      border:1px solid var(--md-outline);
      border-radius:var(--md-radius);
      box-shadow:0 10px 25px rgba(2,6,23,.06);
    }
    .card.pad{padding:14px}
    .card + .card{margin-top:12px}

    .field label{
      display:block; font-size:11px; font-weight:900;
      color:var(--md-muted);
      letter-spacing:.6px;
      margin-bottom:6px;
    }
    .input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-weight:800;
      outline:none;
      color:var(--md-on-surface);
    }
    textarea{resize:none}
    .row{display:flex; gap:10px}
    .row > *{flex:1}

    .btn{
      width:100%;
      padding:13px 14px;
      border:none; border-radius:16px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--md-primary);
      color:var(--md-on-primary);
      box-shadow:0 14px 28px rgba(15,118,110,.25);
    }
    .btn.tonal{
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      border:1px solid rgba(15,118,110,.18);
    }
    .btn.danger{
      background:#FEE2E2; color:#B91C1C; border:1px solid #FECACA;
    }
    .btn.inline{
      width:auto; padding:10px 12px; border-radius:14px;
    }

    .muted{color:var(--md-muted)}
    .tiny{font-size:12px}
    .divider{height:1px;background:var(--md-outline);margin:12px 0}
    .spacer8{height:8px}
    .spacer12{height:12px}
    .spacer16{height:16px}

    /* Flight card */
    .flightCard{
      color:#fff;
      border:none;
      background:linear-gradient(90deg,#2563EB 0%, #0F766E 100%);
      border-radius:22px;
      overflow:hidden;
      position:relative;
      box-shadow:0 18px 40px rgba(2,6,23,.18);
    }
    .flightCard .inner{padding:14px}
    .flightGrid{
      display:grid; grid-template-columns:1fr 1.1fr 1fr;
      gap:10px; align-items:center;
    }
    .flightTime{
      text-align:center;
      border-bottom:1px solid rgba(255,255,255,.22);
      padding-bottom:8px;
    }
    .flightTime .t{
      font-size:26px; font-weight:950; letter-spacing:.4px;
    }
    .flightTime .label{
      margin-top:4px;
      font-size:12px; opacity:.85; font-weight:800;
    }
    .flightTime .ap{
      margin-top:4px;
      font-size:15px; font-weight:950; letter-spacing:.8px;
    }
    .mid{
      text-align:center;
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    .mid .fn{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-weight:900; font-size:12px; opacity:.9; letter-spacing:1px}
    .mid .dur{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.22);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .offsetBadge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:46px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      color:#0F766E;
      font-weight:950;
      border:1px solid rgba(255,255,255,.6);
      box-shadow:0 10px 20px rgba(2,6,23,.18);
    }
    .flightActions{
      margin-top:10px;
      display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
    }
    .flightActions .chip{background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18)}
    .flightActions .chip strong{font-weight:950}

    /* Itinerary items */
    .item{
      display:flex; gap:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--md-outline);
      background:#fff;
      box-shadow:0 10px 18px rgba(2,6,23,.05);
    }
    .timeBox{
      width:78px; flex:0 0 auto;
      border-radius:16px;
      border:1px solid var(--md-outline);
      background:var(--md-surface-2);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:10px 8px;
      cursor:pointer;
    }
    .timeBox .tt{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-weight:950;font-size:20px}
    .timeBox .edit{font-size:11px;color:var(--md-muted);margin-top:3px;font-weight:900}
    .itemMain{flex:1; min-width:0}
    .itemMain input{border:none; padding:0; background:transparent; width:100%; font-weight:950}
    .itemMain .sub{
      margin-top:6px;
      display:flex; align-items:center; gap:8px;
      color:var(--md-muted);
      font-size:12px; font-weight:800;
      min-width:0;
    }
    .locline{
      display:flex; gap:8px; align-items:center; min-width:0;
    }
    .locline input{
      flex:1; min-width:0;
      color:var(--md-muted);
      font-weight:900;
    }
    .pillrow{
      margin-top:10px;
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .lockPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--md-outline);
      background:var(--md-surface-2);
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .lockPill.on{
      border-color:rgba(15,118,110,.35);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
    }

    /* Category pills */
    .catbar{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .catpill{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .catpill.active{
      border-color:rgba(15,118,110,.35);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
    }

    /* Connector (between items) */
    .connector{
      margin:10px 0 16px;
      padding-left:92px;
    }
    .connectorInner{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .routebtn{
      padding:9px 12px; border-radius:999px;
      border:1px solid rgba(15,118,110,.18);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      font-weight:950;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .routechip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-weight:950;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      max-width:100%;
      white-space:nowrap;
    }
    .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px}

    /* Bottom FAB */
    .fabwrap{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      width:100%;
      max-width:430px;
      padding:0 14px;
      pointer-events:none;
      z-index:60;
    }
    .fab{
      pointer-events:auto;
      width:100%;
      border-radius:22px;
      padding:14px;
      font-weight:950;
      display:flex; align-items:center; justify-content:center; gap:10px;
      border:none;
      cursor:pointer;
      background:var(--md-primary);
      color:#fff;
      box-shadow:0 22px 40px rgba(15,118,110,.30);
    }

    /* Wheel modal */
    .overlay{
      position:fixed; inset:0; z-index:100;
      background:rgba(2,6,23,.45);
      backdrop-filter: blur(2px);
      display:flex; align-items:flex-end;
    }
    .sheet{
      width:100%;
      max-width:430px;
      margin:0 auto;
      background:#fff;
      border-radius:26px 26px 0 0;
      border:1px solid var(--md-outline);
      box-shadow:0 -20px 60px rgba(2,6,23,.25);
      padding:14px 14px 20px;
    }
    .sheetHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding:4px 4px 10px;
      border-bottom:1px solid var(--md-outline);
    }
    .sheetHeader .h{
      font-size:16px; font-weight:950;
    }
    .wheel{
      display:flex; justify-content:center;
      height:170px;
      margin-top:14px;
      background:var(--md-surface-2);
      border:1px solid var(--md-outline);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }
    .wheel .hl{
      position:absolute; top:50%; left:0; right:0; height:44px;
      transform:translateY(-50%);
      background:rgba(15,118,110,.10);
      border-top:1px solid rgba(15,118,110,.20);
      border-bottom:1px solid rgba(15,118,110,.20);
      pointer-events:none;
    }
    .wheelcol{
      width:110px;
      overflow:auto;
      scroll-snap-type:y mandatory;
      padding:63px 0;
    }
    .wheelcol::-webkit-scrollbar{display:none}
    .wheelitem{
      height:44px;
      display:flex; align-items:center; justify-content:center;
      scroll-snap-align:center;
      font-weight:900;
      color:#94A3B8;
      font-size:18px;
    }
    .wheelitem.sel{
      color:var(--md-primary);
      font-size:22px;
      font-weight:950;
    }

    /* Translate */
    .chipsGrid{display:flex;gap:8px;flex-wrap:wrap}
    .chipPhrase{
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;font-weight:950;font-size:12px;cursor:pointer;
    }

    /* Money */
    .moneyHero{
      background:linear-gradient(90deg,#0F766E 0%, #115E59 100%);
      color:#fff;
      border:none;
      padding:18px;
      border-radius:22px;
      box-shadow:0 18px 40px rgba(2,6,23,.18);
      position:relative;
      overflow:hidden;
    }
    .moneyHero .big{font-size:38px;font-weight:950;letter-spacing:.4px}
    .moneyHero .small{opacity:.9;font-weight:900}
    .rateBox{
      position:absolute; right:14px; top:14px;
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
    }
    .rateBox input{
      width:110px; text-align:right;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.30);
      background:rgba(255,255,255,.92);
      font-weight:950;
    }

    .listrow{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px;
      border:1px solid var(--md-outline);
      border-radius:18px;
      background:#fff;
    }

    .toast{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#0B1220; color:#fff;
      padding:10px 14px; border-radius:999px;
      font-weight:900; font-size:12px;
      opacity:.95;
      z-index:200;
      box-shadow:0 18px 40px rgba(2,6,23,.25);
    }
  </style>
</head>

<body>
<div id="app" class="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="left">
      <button class="iconbtn" v-if="hasStarted" @click="goBack"><i class="fa-solid fa-arrow-left"></i></button>
      <div class="titlewrap" v-if="hasStarted">
        <div class="title">
          {{ setup.destination }}
          <span class="chip primary small"><strong>{{ totalDays }}</strong> å¤©</span>
        </div>
        <div class="subtitle">{{ fmtDate(setup.startDate) }} - {{ fmtDate(setup.endDate) }}</div>
      </div>
      <div class="titlewrap" v-else>
        <div class="title">Travel Plan</div>
        <div class="subtitle">PWA / Offline-first</div>
      </div>
    </div>

    <div class="seg" v-if="hasStarted">
      <button :class="{active:viewMode==='plan'}" @click="viewMode='plan'"><i class="fa-regular fa-calendar-check"></i></button>
      <button :class="{active:viewMode==='translate'}" @click="viewMode='translate'"><i class="fa-solid fa-language"></i></button>
      <button :class="{active:viewMode==='money'}" @click="viewMode='money'"><i class="fa-solid fa-dollar-sign"></i></button>
    </div>
  </div>

  <!-- Days bar -->
  <div class="daysbar" v-if="hasStarted">
    <div class="daypill" v-for="(d,idx) in days" :key="d.fullDate" :class="{active: currentDayIdx===idx}" @click="currentDayIdx=idx">
      <div class="d">{{ d.shortDate }}</div>
      <div class="n">D{{ idx+1 }}</div>
    </div>
    <div class="daypill" style="width:62px" @click="addDay">
      <div class="n"><i class="fa-solid fa-plus"></i></div>
      <div class="d">åŠ æ—¥</div>
    </div>
  </div>

  <!-- Setup -->
  <div class="content" v-if="!hasStarted">
    <div class="card pad">
      <div class="field">
        <label>ç›®çš„åœ° DESTINATION</label>
        <input class="input" v-model="searchQuery" @input="debounceSearch" placeholder="è¼¸å…¥åŸå¸‚ (ä¾‹å¦‚: å¤§é˜ª, æ›¼è°·...)" />
        <div class="spacer8"></div>

        <div v-if="suggestions.length" class="card" style="border-radius:18px; overflow:hidden">
          <div v-for="(s,i) in suggestions" :key="i" style="padding:12px 14px;border-bottom:1px solid var(--md-outline);cursor:pointer"
               @click="selectLocation(s)">
            <div style="font-weight:950">{{ s.display_name.split(',')[0] }}</div>
            <div class="tiny muted" style="margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ s.display_name }}</div>
          </div>
        </div>

        <div v-if="detectedCountry" class="spacer12"></div>
        <div v-if="detectedCountry" class="card pad" style="border-radius:18px;background:rgba(15,118,110,.08);border-color:rgba(15,118,110,.18)">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div style="font-weight:950;color:var(--md-primary)">
              <i class="fa-solid fa-circle-check"></i> åµæ¸¬åˆ°ï¼š{{ detectedCountry }}
            </div>
            <div class="chip small" style="border-color:rgba(15,118,110,.25);background:#fff;color:var(--md-primary)">
              è½‰ç‚º <strong>{{ setup.currency }}</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="spacer16"></div>

      <div class="row">
        <div class="field">
          <label>å»ç¨‹ START</label>
          <input class="input" type="date" v-model="setup.startDate" />
        </div>
        <div class="field">
          <label>å›ç¨‹ END</label>
          <input class="input" type="date" v-model="setup.endDate" />
        </div>
      </div>

      <div class="spacer16"></div>

      <div class="field">
        <label>è²¨å¹£ CURRENCY</label>
        <select class="input" v-model="setup.currency">
          <optgroup label="Asia">
            <option value="TWD">TWD å°å¹£</option>
            <option value="JPY">JPY æ—¥å¹£</option>
            <option value="KRW">KRW éŸ“å…ƒ</option>
            <option value="CNY">CNY äººæ°‘å¹£</option>
            <option value="HKD">HKD æ¸¯å¹£</option>
            <option value="THB">THB æ³°éŠ–</option>
            <option value="SGD">SGD æ–°å¹£</option>
            <option value="VND">VND è¶Šå—ç›¾</option>
            <option value="MYR">MYR é¦¬å¹£</option>
            <option value="PHP">PHP æŠ«ç´¢</option>
            <option value="IDR">IDR å°å°¼ç›¾</option>
          </optgroup>
          <optgroup label="Americas">
            <option value="USD">USD ç¾é‡‘</option>
            <option value="CAD">CAD åŠ å¹£</option>
          </optgroup>
          <optgroup label="Europe">
            <option value="EUR">EUR æ­å…ƒ</option>
            <option value="GBP">GBP è‹±éŠ</option>
            <option value="CHF">CHF ç‘å£«æ³•éƒ</option>
          </optgroup>
          <optgroup label="Oceania">
            <option value="AUD">AUD æ¾³å¹£</option>
            <option value="NZD">NZD ç´å¹£</option>
          </optgroup>
        </select>
      </div>

      <div class="spacer16"></div>

      <button class="btn primary" @click="initTrip">
        å»ºç«‹è¡Œç¨‹
      </button>

      <div class="spacer12"></div>
      <div class="tiny muted">
        ç„¡é‡‘é‘°å®šä½ï¼šOpenStreetMap Nominatimï¼›è·¯ç·šæ™‚é–“ï¼šOSRM(æ­¥è¡Œ/é–‹è»Š)ï¼›å¤§çœ¾é‹è¼¸ä»¥ Google Maps é–‹å•Ÿã€‚
      </div>
    </div>

    <div class="spacer12"></div>

    <div class="card pad">
      <div style="font-weight:950">PWA ç‹€æ…‹</div>
      <div class="tiny muted" style="margin-top:6px">
        Service Workerï¼š<strong>{{ swStatus }}</strong>
      </div>
      <div class="spacer12"></div>
      <button class="btn tonal" @click="forceReload">é‡æ–°è¼‰å…¥ï¼ˆæ¸…å¿«å–å¾Œå»ºè­°ç”¨ï¼‰</button>
    </div>
  </div>

  <!-- Main -->
  <div class="content" v-else>
    <!-- PLAN -->
    <div v-if="viewMode==='plan'">
      <div class="card pad">
        <div style="font-size:18px;font-weight:950">{{ currentDay.date }}</div>
        <div class="spacer8"></div>
        <input class="input" v-model="currentDay.title" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ..." />
      </div>

      <!-- Flights (multi segments) -->
      <div class="spacer12"></div>
      <div class="flightCard" v-if="currentDayFlights.length">
        <div class="inner">
          <div v-for="(seg,si) in currentDayFlights" :key="seg.id" style="margin-bottom:14px">
            <div class="flightGrid">
              <div class="flightTime">
                <div class="t">{{ seg.departTime }}</div>
                <div class="label">èµ·é£›</div>
                <div class="ap">{{ seg.departAirport || '---' }}</div>
              </div>

              <div class="mid">
                <div class="fn">{{ seg.flightNo || 'FLIGHT' }}</div>
                <div class="dur">
                  <i class="fa-solid fa-plane"></i>
                  <span>é£›è¡Œ {{ minsToHM(seg.durationMin) }}</span>
                </div>
                <div v-if="seg.arrivalOffset==='1'" class="offsetBadge">+1æ—¥</div>
              </div>

              <div class="flightTime">
                <div class="t">{{ seg.arriveTime }}</div>
                <div class="label">æŠµé”</div>
                <div class="ap">{{ seg.arriveAirport || '---' }}</div>
              </div>
            </div>

            <div class="flightActions">
              <span class="chip small" @click="openFlightEditor(seg.id)"><strong>ç·¨è¼¯</strong> èˆªç­</span>
              <span class="chip small" @click="removeFlight(seg.id)"><strong>åˆªé™¤</strong></span>
            </div>

            <div v-if="si < currentDayFlights.length-1" class="spacer12"></div>
          </div>

          <button class="btn inline tonal" @click="addFlightSegment" style="width:100%;border-radius:18px">
            <i class="fa-solid fa-plus"></i> æ–°å¢èˆªç­ï¼ˆè½‰æ©Ÿ/ç¬¬äºŒæ®µä¹ŸæŒ‰é€™å€‹ï¼‰
          </button>
        </div>
      </div>

      <div v-else class="card pad">
        <button class="btn tonal" @click="addFlightSegment">
          <i class="fa-solid fa-plane"></i> æ–°å¢ç•¶æ—¥èˆªç­ï¼ˆæ”¯æ´è½‰æ©Ÿ/å…©æ®µï¼‰
        </button>
      </div>

      <!-- Itinerary -->
      <div class="spacer12"></div>

      <div v-for="(it, idx) in currentDay.items" :key="it.id">
        <div class="item">
          <div class="timeBox" @click="openWheel('time', idx)">
            <div class="tt">{{ it.time || '--:--' }}</div>
            <div class="edit">ä¿®æ”¹</div>
          </div>

          <div class="itemMain">
            <input v-model="it.activity" placeholder="è¡Œç¨‹åç¨±..." />
            <div class="sub">
              <i class="fa-solid fa-location-dot" style="color:var(--md-primary)"></i>
              <div class="locline">
                <input v-model="it.location" placeholder="åœ°é»ï¼ˆè¼¸å…¥åº—å/æ™¯é»ï¼Œé»å³å´å®šä½ï¼‰" @blur="autoGeocode(idx)" />
                <span class="chip small" @click="geocodeItem(idx)"><i class="fa-solid fa-crosshairs"></i> å®šä½</span>
              </div>
            </div>

            <div class="tiny muted" v-if="it.geo && it.geo.display" style="margin-top:6px;display:flex;gap:8px;align-items:center">
              <span class="chip small" style="background:rgba(15,118,110,.10);border-color:rgba(15,118,110,.18);color:var(--md-primary)">
                å·²å®šä½
              </span>
              <span class="truncate">{{ it.geo.display }}</span>
            </div>

            <div class="catbar">
              <span v-for="c in categories" :key="c.key"
                class="catpill" :class="{active: it.category===c.key}"
                @click="it.category = c.key; saveAll()">
                <i class="fa-solid" :class="c.icon"></i> {{ c.label }}
              </span>
            </div>

            <div class="pillrow">
              <span class="routechip" @click="openWheel('stay', idx)">
                <i class="fa-solid fa-hourglass-half"></i>
                åœç•™ {{ minsToHM(it.stayMin) }}
              </span>

              <span class="lockPill" :class="{on: it.locked}" @click="it.locked=!it.locked; saveAll(); autoReschedule(currentDayIdx)">
                <i class="fa-solid fa-lock" v-if="it.locked"></i>
                <i class="fa-solid fa-lock-open" v-else></i>
                {{ it.locked ? 'å·²é–å®šæ™‚é–“' : 'æœªé–å®š' }}
              </span>

              <span class="chip small" @click="removeItem(idx)" style="border-color:#FECACA;background:#FEE2E2;color:#B91C1C">
                <i class="fa-solid fa-trash"></i> åˆªé™¤
              </span>
            </div>
          </div>
        </div>

        <!-- Connector to next -->
        <div class="connector" v-if="idx < currentDay.items.length-1">
          <div class="connectorInner">
            <span class="routechip" @click="openWheel('transit', idx)">
              <i class="fa-solid" :class="getTransIcon(it.toNext.mode)"></i>
              {{ transLabel(it.toNext) }}
            </span>

            <button class="routebtn" @click="calcRoutes(idx)">
              <i class="fa-solid fa-route"></i> è·¯ç·š
            </button>

            <span class="routechip" v-if="it.route && it.route.walkMin!=null">
              ğŸš¶ æ­¥è¡Œ {{ it.route.walkMin }}m
            </span>
            <span class="routechip" v-if="it.route && it.route.driveMin!=null">
              ğŸš— é–‹è»Š {{ it.route.driveMin }}m
            </span>
            <span class="routechip">
              ğŸš‡ <span class="truncate">å¤§çœ¾é‹è¼¸ç”¨ Google</span>
            </span>

            <button class="routebtn" @click="openGoogleDirections(idx)">
              <i class="fa-brands fa-google"></i> Google Maps
            </button>
          </div>
          <div class="spacer8"></div>
        </div>
      </div>

      <div class="fabwrap">
        <button class="fab" @click="addItem">
          <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
        </button>
      </div>
    </div>

    <!-- TRANSLATE -->
    <div v-if="viewMode==='translate'">
      <div class="card pad">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div style="font-weight:950;font-size:18px">
            <i class="fa-solid fa-language" style="color:var(--md-primary)"></i> ç¿»è­¯
          </div>
          <button class="btn inline tonal" @click="swapLang" style="border-radius:999px">
            <i class="fa-solid fa-right-left"></i> äº¤æ›
          </button>
        </div>

        <div class="spacer16"></div>

        <div class="row">
          <div class="field">
            <label>ä¾†æºèªè¨€</label>
            <select class="input" v-model="tr.from">
              <option v-for="l in langs" :key="l.code" :value="l.code">{{ l.label }}</option>
            </select>
          </div>
          <div class="field">
            <label>ç›®æ¨™èªè¨€</label>
            <select class="input" v-model="tr.to">
              <option v-for="l in langs" :key="l.code" :value="l.code">{{ l.label }}</option>
            </select>
          </div>
        </div>

        <div class="spacer16"></div>

        <div class="field">
          <label>è¼¸å…¥æ–‡å­—</label>
          <textarea class="input" rows="4" v-model="tr.text" placeholder="è¼¸å…¥è¦ç¿»è­¯çš„å¥å­..."></textarea>
        </div>

        <div class="spacer12"></div>

        <div class="chipsGrid">
          <span class="chipPhrase" v-for="p in quickPhrases" :key="p" @click="tr.text=p">{{ p }}</span>
        </div>

        <div class="spacer16"></div>

        <div class="row">
          <button class="btn primary" @click="openGoogleTranslate">
            <i class="fa-brands fa-google"></i> ç”¨ Google ç¿»è­¯é–‹å•Ÿ
          </button>
        </div>

        <div class="spacer10"></div>

        <div class="row">
          <button class="btn tonal" @click="copyText">
            <i class="fa-regular fa-copy"></i> è¤‡è£½æ–‡å­—
          </button>
          <button class="btn danger" @click="tr.text=''">
            <i class="fa-solid fa-xmark"></i> æ¸…ç©º
          </button>
        </div>

        <div class="spacer12"></div>
        <div class="tiny muted">
          ä½ æ²’æœ‰ ChatGPT é‡‘é‘°æ™‚ï¼šæœ€ç©©çš„ä½œæ³•å°±æ˜¯ç”¨ Google Translateã€Œé–‹æ–°é ã€ç¿»è­¯ï¼ˆä¸åƒ API / ä¸ç”¨é‡‘é‘°ï¼‰ï¼Œé€™ç‰ˆå°±æ˜¯é€™æ¨£åšã€‚
        </div>
      </div>
    </div>

    <!-- MONEY -->
    <div v-if="viewMode==='money'">
      <div class="moneyHero">
        <div class="rateBox">
          <div class="tiny small">åŒ¯ç‡ï¼ˆ{{ setup.currency }}â†’TWDï¼‰</div>
          <input type="number" step="0.0001" v-model.number="exchangeRate" @change="saveAll" />
          <div class="tiny" style="opacity:.9">
            æ›´æ–°ï¼š{{ fxLastUpdated || 'æœªæ›´æ–°' }}
          </div>
        </div>

        <div class="small">ç¸½æ”¯å‡º Total</div>
        <div class="big">{{ setup.currency }} {{ totalExpense.toLocaleString() }}</div>
        <div class="small" style="margin-top:8px">â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</div>
      </div>

      <div class="spacer12"></div>

      <div class="card pad">
        <div style="font-weight:950">æ¯æ—¥æ”¯å‡º</div>
        <div class="spacer12"></div>
        <div v-for="(amt, idx) in dailyTotals" :key="idx" class="listrow" style="margin-bottom:10px">
          <div style="font-weight:950">D{{ idx+1 }} <span class="tiny muted">ï¼ˆ{{ days[idx]?.shortDate || '' }}ï¼‰</span></div>
          <div style="font-weight:950">{{ setup.currency }} {{ amt.toLocaleString() }}</div>
        </div>
      </div>

      <div class="spacer12"></div>

      <div class="card pad">
        <div style="font-weight:950;margin-bottom:10px">æ–°å¢æ”¯å‡º</div>
        <div class="row">
          <input class="input" v-model="newExpense.item" placeholder="é …ç›®" />
          <input class="input" type="number" v-model.number="newExpense.amount" placeholder="é‡‘é¡" />
        </div>
        <div class="spacer12"></div>
        <div class="row">
          <select class="input" v-model.number="newExpense.dayIdx">
            <option v-for="(d, idx) in days" :key="d.fullDate" :value="idx">D{{ idx+1 }}ï¼ˆ{{ d.shortDate }}ï¼‰</option>
          </select>
          <button class="btn primary" @click="addExpense">+ åŠ å…¥</button>
        </div>
      </div>

      <div class="spacer12"></div>

      <div class="card pad">
        <div style="font-weight:950;margin-bottom:10px">æ˜ç´°</div>
        <div v-if="expenses.length===0" class="tiny muted">å°šç„¡æ”¯å‡ºã€‚</div>
        <div v-else>
          <div class="listrow" v-for="(e,i) in expenses" :key="e.id" style="margin-bottom:10px">
            <div style="min-width:0">
              <div style="font-weight:950">{{ e.item }}</div>
              <div class="tiny muted">D{{ (e.dayIdx??0)+1 }}</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="font-weight:950">{{ setup.currency }} {{ Number(e.amount||0).toLocaleString() }}</div>
              <button class="chip small" style="border-color:#FECACA;background:#FEE2E2;color:#B91C1C" @click="removeExpense(i)">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="spacer12"></div>
        <button class="btn tonal" @click="refreshFX(true)">
          <i class="fa-solid fa-rotate"></i> ç«‹åˆ»åˆ·æ–°åŒ¯ç‡ï¼ˆé è¨­æ¯å¤©åªæ›´æ–°ä¸€æ¬¡ï¼‰
        </button>
      </div>
    </div>
  </div>

  <!-- Wheel modal -->
  <div class="overlay" v-if="wheel.show" @click.self="closeWheel">
    <div class="sheet">
      <div class="sheetHeader">
        <div>
          <div class="h">{{ wheelTitle }}</div>
          <div class="tiny muted">æ»‘å‹•é¸æ“‡å¾ŒæŒ‰ã€Œç¢ºèªã€</div>
        </div>
        <button class="btn inline primary" style="width:auto" @click="saveWheel">ç¢ºèª</button>
      </div>

      <div v-if="wheel.mode==='transit'" class="spacer12"></div>
      <div v-if="wheel.mode==='transit'" class="row">
        <button class="btn tonal" :class="{'primary': wheel.transMode==='walk'}" @click="wheel.transMode='walk'">
          <i class="fa-solid fa-person-walking"></i> æ­¥è¡Œ
        </button>
        <button class="btn tonal" :class="{'primary': wheel.transMode==='drive'}" @click="wheel.transMode='drive'">
          <i class="fa-solid fa-car"></i> é–‹è»Š
        </button>
        <button class="btn tonal" :class="{'primary': wheel.transMode==='transit'}" @click="wheel.transMode='transit'">
          <i class="fa-solid fa-train-subway"></i> å¤§çœ¾
        </button>
      </div>

      <div class="wheel">
        <div class="hl"></div>

        <div class="wheelcol" ref="wheelA" @scroll="onScroll('a')">
          <div class="wheelitem" v-for="v in listA" :key="v" :class="{sel: wheel.a===v}">{{ v }}</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:center;width:22px;font-weight:950;color:#94A3B8">
          {{ wheel.mode==='time' ? ':' : 'h' }}
        </div>

        <div class="wheelcol" ref="wheelB" @scroll="onScroll('b')">
          <div class="wheelitem" v-for="v in listB" :key="v" :class="{sel: wheel.b===v}">{{ v }}</div>
        </div>

        <div v-if="wheel.mode!=='time'" style="display:flex;align-items:center;justify-content:center;width:22px;font-weight:950;color:#94A3B8">
          m
        </div>
      </div>
    </div>
  </div>

  <div class="toast" v-if="toast">{{ toast }}</div>
</div>

<script>
const { createApp, ref, reactive, computed, watch, nextTick, onMounted } = Vue;

createApp({
  setup(){
    const STORAGE_KEY = 'tp_pwa_data_v2';
    const hasStarted = ref(false);
    const viewMode = ref('plan');
    const currentDayIdx = ref(0);

    const todayStr = new Date().toISOString().split('T')[0];
    const setup = reactive({
      destination: '',
      startDate: todayStr,
      endDate: todayStr,
      currency: 'JPY'
    });

    const days = ref([]);
    const totalDays = ref(0);

    // destination search
    const searchQuery = ref('');
    const suggestions = ref([]);
    const detectedCountry = ref('');
    const isSearching = ref(false);
    let debounceTimer = null;

    const countryCurrencyMap = {
      'tw': 'TWD', 'jp': 'JPY', 'kr': 'KRW', 'cn': 'CNY', 'hk': 'HKD', 'th': 'THB', 'vn': 'VND',
      'sg': 'SGD', 'my': 'MYR', 'ph': 'PHP', 'id': 'IDR', 'us': 'USD', 'ca': 'CAD', 'au': 'AUD',
      'nz': 'NZD', 'gb': 'GBP', 'ch': 'CHF',
      'fr': 'EUR', 'de': 'EUR', 'it': 'EUR', 'es': 'EUR', 'pt': 'EUR', 'nl': 'EUR', 'be': 'EUR',
      'at': 'EUR', 'gr': 'EUR', 'fi': 'EUR', 'ie': 'EUR'
    };

    // categories
    const categories = [
      { key:'food', label:'ç¾é£Ÿ', icon:'fa-utensils' },
      { key:'shopping', label:'è³¼ç‰©', icon:'fa-bag-shopping' },
      { key:'hotel', label:'ä½å®¿', icon:'fa-hotel' },
      { key:'fun', label:'éŠæ¨‚', icon:'fa-ticket' },
      { key:'transport', label:'äº¤é€š', icon:'fa-bus' },
      { key:'spot', label:'æ™¯é»', icon:'fa-mountain-sun' },
    ];

    // flights store at trip-level
    const flights = ref([]); // {id, departDayIdx, arriveDayIdx, departTime, arriveTime, departAirport, arriveAirport, flightNo, arrivalOffset, durationMin}

    // itinerary items
    const makeItem = () => ({
      id: crypto.randomUUID(),
      time: '',
      activity: '',
      location: '',
      geo: null, // {lat, lon, display}
      category: 'spot',
      stayMin: 60,
      locked: false,
      toNext: { mode:'drive', min: 30 },
      route: null // {walkMin, driveMin}
    });

    // Money
    const expenses = ref([]); // {id, item, amount, dayIdx}
    const newExpense = reactive({ item:'', amount:'', dayIdx:0 });
    const exchangeRate = ref(1); // TWD per currency
    const fxLastUpdated = ref('');
    const FX_CACHE_KEY = 'tp_fx_cache_v1';

    // translate
    const langs = [
      { code:'zh-TW', label:'ç¹ä¸­' },
      { code:'en', label:'è‹±æ–‡' },
      { code:'ja', label:'æ—¥æ–‡' },
      { code:'ko', label:'éŸ“æ–‡' },
      { code:'th', label:'æ³°æ–‡' },
      { code:'vi', label:'è¶Šå—æ–‡' },
      { code:'fr', label:'æ³•æ–‡' },
      { code:'de', label:'å¾·æ–‡' },
      { code:'es', label:'è¥¿æ–‡' },
      { code:'it', label:'ç¾©å¤§åˆ©æ–‡' },
    ];
    const tr = reactive({ from:'zh-TW', to:'en', text:'' });
    const quickPhrases = [
      'è«‹å•é€™è£¡æ€éº¼å»ï¼Ÿ',
      'æˆ‘è¦é»é¤ï¼Œè¬è¬ã€‚',
      'å¯ä»¥åˆ·å¡å—ï¼Ÿ',
      'é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ',
      'æˆ‘æƒ³è¦ä¸€ä»½ä¸è¾£ã€‚',
      'è«‹å¹«æˆ‘å«è¨ˆç¨‹è»Šã€‚'
    ];

    // toast
    const toast = ref('');
    let toastTimer = null;
    const showToast = (msg) => {
      toast.value = msg;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.value='', 1800);
    };

    // SW status
    const swStatus = ref('æœªè¨»å†Š');
    const forceReload = () => location.reload(true);

    // helpers
    const fmtDate = (s) => (s||'').replaceAll('-','/');
    const minsToHM = (m) => {
      m = Math.max(0, Math.round(Number(m||0)));
      const h = Math.floor(m/60);
      const mm = m%60;
      if(h<=0) return `${mm}m`;
      return `${h}h ${mm.toString().padStart(2,'0')}m`;
    };
    const pad2 = (n) => String(n).padStart(2,'0');
    const parseTimeToMin = (t) => {
      if(!t || !t.includes(':')) return null;
      const [h,m]=t.split(':').map(Number);
      if(Number.isNaN(h)||Number.isNaN(m)) return null;
      return h*60+m;
    };
    const minToTime = (m) => {
      m = ((m%1440)+1440)%1440;
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${pad2(h)}:${pad2(mm)}`;
    };

    // computed
    const currentDay = computed(() => days.value[currentDayIdx.value] || { title:'', date:'', items:[] });

    const currentDayFlights = computed(() => {
      const idx = currentDayIdx.value;
      return flights.value
        .filter(f => f.departDayIdx===idx || f.arriveDayIdx===idx)
        .sort((a,b)=> (a.departDayIdx-b.departDayIdx) || (parseTimeToMin(a.departTime||'')??0) - (parseTimeToMin(b.departTime||'')??0));
    });

    const totalExpense = computed(() => expenses.value.reduce((s,e)=> s + Number(e.amount||0), 0));
    const dailyTotals = computed(() => {
      const arr = Array.from({length: days.value.length}, ()=>0);
      for(const e of expenses.value){
        const di = Number(e.dayIdx??0);
        if(arr[di]!=null) arr[di] += Number(e.amount||0);
      }
      return arr;
    });

    // persistence
    const saveAll = () => {
      const payload = {
        hasStarted: hasStarted.value,
        viewMode: viewMode.value,
        currentDayIdx: currentDayIdx.value,
        setup: {...setup},
        days: days.value,
        flights: flights.value,
        expenses: expenses.value,
        exchangeRate: exchangeRate.value,
        fxLastUpdated: fxLastUpdated.value,
        tr: {...tr}
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    };

    const loadAll = () => {
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        if(d.setup){
          Object.assign(setup, d.setup);
          searchQuery.value = d.setup.destination || '';
        }
        if(Array.isArray(d.days)) days.value = d.days;
        if(Array.isArray(d.flights)) flights.value = d.flights;
        if(Array.isArray(d.expenses)) expenses.value = d.expenses;
        if(typeof d.exchangeRate === 'number') exchangeRate.value = d.exchangeRate;
        if(d.fxLastUpdated) fxLastUpdated.value = d.fxLastUpdated;
        if(d.tr) Object.assign(tr, d.tr);
        hasStarted.value = !!d.hasStarted;
        viewMode.value = d.viewMode || 'plan';
        currentDayIdx.value = Math.min(d.currentDayIdx||0, (days.value.length||1)-1);
        totalDays.value = days.value.length || 0;
      }catch(_){}
    };

    watch([() => setup.destination, () => setup.startDate, () => setup.endDate, () => setup.currency], saveAll);
    watch(days, saveAll, {deep:true});
    watch(flights, saveAll, {deep:true});
    watch(expenses, saveAll, {deep:true});
    watch(exchangeRate, saveAll);

    // init trip
    const initTrip = () => {
      if(!setup.destination) return alert('è«‹å…ˆé¸æ“‡ç›®çš„åœ°');
      const start = new Date(setup.startDate);
      const end = new Date(setup.endDate);
      if(end < start) return alert('å›ç¨‹æ—¥æœŸä¸èƒ½æ—©æ–¼å»ç¨‹æ—¥æœŸ');

      const diff = Math.round((end-start)/(1000*60*60*24));
      totalDays.value = diff + 1;

      const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      days.value = [];
      let d = new Date(start);
      for(let i=0;i<totalDays.value;i++){
        const mm = d.getMonth()+1, dd=d.getDate();
        days.value.push({
          title:'',
          shortDate: `${mm}/${dd}`,
          date: `${mm}/${dd} (${weekDays[d.getDay()]})`,
          fullDate: d.toISOString().split('T')[0],
          items: []
        });
        d.setDate(d.getDate()+1);
      }

      // default item
      days.value[0].items.push(makeItem());
      currentDayIdx.value = 0;
      hasStarted.value = true;

      // ensure expense dayIdx valid
      newExpense.dayIdx = 0;

      // refresh FX daily
      refreshFX(false);

      saveAll();
    };

    const addDay = () => {
      if(!days.value.length) return;
      const last = new Date(days.value[days.value.length-1].fullDate);
      last.setDate(last.getDate()+1);
      const weekDays=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      days.value.push({
        title:'',
        shortDate:`${last.getMonth()+1}/${last.getDate()}`,
        date:`${last.getMonth()+1}/${last.getDate()} (${weekDays[last.getDay()]})`,
        fullDate:last.toISOString().split('T')[0],
        items:[]
      });
      setup.endDate = last.toISOString().split('T')[0];
      totalDays.value++;
      currentDayIdx.value = days.value.length-1;
      saveAll();
    };

    const goBack = () => {
      if(confirm('è¿”å›åˆå§‹åŒ–é ï¼Ÿï¼ˆè³‡æ–™æœƒä¿ç•™åœ¨æœ¬æ©Ÿï¼‰')){
        hasStarted.value = false;
        viewMode.value = 'plan';
        saveAll();
      }
    };

    // destination search
    const debounceSearch = () => {
      clearTimeout(debounceTimer);
      suggestions.value = [];
      if(!searchQuery.value){ return; }
      isSearching.value = true;
      debounceTimer = setTimeout(async ()=>{
        try{
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery.value)}&addressdetails=1&limit=6`);
          const data = await res.json();
          suggestions.value = Array.isArray(data)?data:[];
        }catch(_){
        }finally{
          isSearching.value = false;
        }
      }, 500);
    };

    const selectLocation = (item) => {
      const cityName = item.display_name.split(',')[0];
      setup.destination = cityName;
      searchQuery.value = cityName;

      const cc = item?.address?.country_code;
      const countryName = item?.address?.country;
      if(cc && countryCurrencyMap[cc]){
        setup.currency = countryCurrencyMap[cc];
        detectedCountry.value = `${countryName} (${setup.currency})`;
      }else{
        detectedCountry.value = '';
      }
      suggestions.value = [];
      saveAll();
    };

    // flights
    const addFlightSegment = () => {
      const id = crypto.randomUUID();
      const departDayIdx = currentDayIdx.value;
      const seg = {
        id,
        departDayIdx,
        arriveDayIdx: departDayIdx,
        departTime: '09:00',
        arriveTime: '13:00',
        departAirport: 'TPE',
        arriveAirport: 'NRT',
        flightNo: 'BR198',
        arrivalOffset: '0',
        durationMin: 240
      };
      // compute duration
      seg.durationMin = computeFlightDuration(seg);
      flights.value.push(seg);
      saveAll();
      openFlightEditor(id);
    };

    const computeFlightDuration = (seg) => {
      const s = parseTimeToMin(seg.departTime);
      const e = parseTimeToMin(seg.arriveTime);
      if(s==null || e==null) return seg.durationMin || 0;
      let dur = e - s;
      if(seg.arrivalOffset==='1') dur += 1440;
      if(dur < 0) dur += 1440;
      return Math.max(0, dur);
    };

    const openFlightEditor = (id) => {
      const seg = flights.value.find(x=>x.id===id);
      if(!seg) return;
      const input = prompt(
`ç·¨è¼¯èˆªç­ï¼ˆç”¨ | åˆ†éš”ï¼‰ï¼š
æ ¼å¼ï¼šèµ·é£›æ™‚é–“|èµ·é£›å ´|æŠµé”æ™‚é–“|æŠµé”å ´|èˆªç­è™Ÿ|+1(0/1)

ä¾‹å¦‚ï¼š12:25|TPE|14:20|NRT|BR198|1`,
`${seg.departTime}|${seg.departAirport}|${seg.arriveTime}|${seg.arriveAirport}|${seg.flightNo}|${seg.arrivalOffset}`
      );
      if(!input) return;
      const parts = input.split('|').map(s=>s.trim());
      if(parts.length < 6) return alert('æ ¼å¼ä¸å°');
      seg.departTime = parts[0] || seg.departTime;
      seg.departAirport = (parts[1]||'').toUpperCase();
      seg.arriveTime = parts[2] || seg.arriveTime;
      seg.arriveAirport = (parts[3]||'').toUpperCase();
      seg.flightNo = (parts[4]||'').toUpperCase();
      seg.arrivalOffset = (parts[5]==='1')?'1':'0';

      // day move
      seg.departDayIdx = currentDayIdx.value;
      seg.arriveDayIdx = currentDayIdx.value + (seg.arrivalOffset==='1'?1:0);

      // clamp
      if(seg.arriveDayIdx >= days.value.length) seg.arriveDayIdx = days.value.length-1;

      seg.durationMin = computeFlightDuration(seg);
      saveAll();
      showToast('å·²æ›´æ–°èˆªç­');
    };

    const removeFlight = (id) => {
      if(!confirm('åˆªé™¤é€™æ®µèˆªç­ï¼Ÿ')) return;
      flights.value = flights.value.filter(f=>f.id!==id);
      saveAll();
    };

    // itinerary
    const addItem = () => {
      currentDay.value.items.push(makeItem());
      // default time: if last exists, set after it (stay+toNext)
      autoReschedule(currentDayIdx.value);
      saveAll();
    };

    const removeItem = (idx) => {
      currentDay.value.items.splice(idx,1);
      autoReschedule(currentDayIdx.value);
      saveAll();
    };

    const getTransIcon = (mode) => {
      return ({
        walk:'fa-person-walking',
        drive:'fa-car',
        transit:'fa-train-subway'
      }[mode] || 'fa-car');
    };
    const transLabel = (toNext) => {
      const modeMap = { walk:'æ­¥è¡Œ', drive:'é–‹è»Š', transit:'å¤§çœ¾' };
      const m = Number(toNext?.min||0);
      return `${modeMap[toNext?.mode]||'äº¤é€š'} Â· ${m}min`;
    };

    // auto schedule (stay + transit)
    const autoReschedule = (dayIdx) => {
      const d = days.value[dayIdx];
      if(!d || !Array.isArray(d.items) || d.items.length===0) return;

      // if no start time, set first to 09:00
      if(!d.items[0].time) d.items[0].time = '09:00';

      // order by current order (do not reorder categories)
      let cursor = parseTimeToMin(d.items[0].time) ?? 540;

      for(let i=0;i<d.items.length;i++){
        const it = d.items[i];

        if(it.locked && it.time){
          const t = parseTimeToMin(it.time);
          if(t!=null) cursor = t; // anchor to locked
        }else{
          it.time = minToTime(cursor);
        }

        const stay = Number(it.stayMin||0);
        cursor += stay;

        // transit to next
        if(i < d.items.length-1){
          const tm = Number(it.toNext?.min||0);
          cursor += tm;
        }
      }
      saveAll();
    };

    // geocoding
    const geocodeItem = async (idx) => {
      const it = currentDay.value.items[idx];
      if(!it || !it.location) return;
      try{
        const q = `${it.location} ${setup.destination}`.trim();
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
        const data = await res.json();
        if(data && data[0]){
          it.geo = { lat:Number(data[0].lat), lon:Number(data[0].lon), display:data[0].display_name };
          showToast('å®šä½å®Œæˆ');
          saveAll();
        }else{
          alert('æ‰¾ä¸åˆ°å®šä½ï¼Œæ›å€‹é—œéµå­—ï¼ˆåº—å+åŸå¸‚ï¼‰');
        }
      }catch(_){
        alert('å®šä½å¤±æ•—ï¼ˆç¶²è·¯æˆ–æœå‹™é™åˆ¶ï¼‰');
      }
    };
    const autoGeocode = (idx) => {
      const it = currentDay.value.items[idx];
      if(!it) return;
      if(it.geo && it.geo.display) return; // already
      if((it.location||'').length < 3) return;
      // auto but quiet
      geocodeItem(idx);
    };

    // route calc via OSRM (walk/driving)
    const osrm = async (profile, a, b) => {
      const url = `https://router.project-osrm.org/route/v1/${profile}/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
      const res = await fetch(url);
      const j = await res.json();
      const sec = j?.routes?.[0]?.duration;
      if(!sec && sec!==0) return null;
      return Math.max(1, Math.round(sec/60));
    };

    const calcRoutes = async (idx) => {
      const a = currentDay.value.items[idx];
      const b = currentDay.value.items[idx+1];
      if(!a?.geo || !b?.geo) return alert('å…©å€‹é»éƒ½è¦å…ˆã€Œå·²å®šä½ã€æ‰èƒ½ç®—è·¯ç·š');

      a.route = a.route || {};
      showToast('è¨ˆç®—è·¯ç·šä¸­...');
      try{
        const walk = await osrm('walking', a.geo, b.geo);
        const drive = await osrm('driving', a.geo, b.geo);
        a.route.walkMin = walk;
        a.route.driveMin = drive;
        saveAll();
        showToast('è·¯ç·šå·²æ›´æ–°');
      }catch(_){
        alert('è·¯ç·šè¨ˆç®—å¤±æ•—ï¼ˆOSRMæœå‹™æˆ–ç¶²è·¯å•é¡Œï¼‰');
      }
    };

    const openGoogleDirections = (idx) => {
      const a = currentDay.value.items[idx];
      const b = currentDay.value.items[idx+1];
      if(!a || !b) return;
      const origin = a.geo ? `${a.geo.lat},${a.geo.lon}` : encodeURIComponent(a.location||'');
      const dest = b.geo ? `${b.geo.lat},${b.geo.lon}` : encodeURIComponent(b.location||'');
      const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
      window.open(url, '_blank');
    };

    // wheel modal
    const wheel = reactive({
      show:false,
      mode:'time', // time | stay | transit
      idx:null,
      a:'09',
      b:'00',
      transMode:'drive'
    });
    const wheelA = ref(null);
    const wheelB = ref(null);

    const wheelTitle = computed(() => {
      if(wheel.mode==='time') return 'è¨­å®šé–‹å§‹æ™‚é–“';
      if(wheel.mode==='stay') return 'è¨­å®šåœç•™æ™‚é–“';
      return 'è¨­å®šäº¤é€šæ™‚é–“';
    });

    const listA = computed(() => {
      if(wheel.mode==='time') return Array.from({length:24},(_,i)=>pad2(i));
      // duration hours
      return Array.from({length:10},(_,i)=>pad2(i));
    });
    const listB = computed(() => {
      if(wheel.mode==='time') return Array.from({length:12},(_,i)=>pad2(i*5));
      // minutes
      return Array.from({length:12},(_,i)=>pad2(i*5));
    });

    const openWheel = (mode, idx) => {
      wheel.mode = mode;
      wheel.idx = idx;
      wheel.show = true;

      const it = currentDay.value.items[idx];

      if(mode==='time'){
        const t = it.time || '09:00';
        const [h,m] = t.split(':');
        wheel.a = h; wheel.b = m;
      }else if(mode==='stay'){
        const m = Number(it.stayMin||0);
        wheel.a = pad2(Math.floor(m/60));
        wheel.b = pad2(m%60);
      }else if(mode==='transit'){
        wheel.transMode = it.toNext?.mode || 'drive';
        const m = Number(it.toNext?.min||0);
        wheel.a = pad2(Math.floor(m/60));
        wheel.b = pad2(m%60);
      }

      nextTick(() => {
        scrollTo(wheelA.value, wheel.a);
        scrollTo(wheelB.value, wheel.b);
      });
    };

    const closeWheel = () => wheel.show = false;

    const scrollTo = (el, val) => {
      if(!el) return;
      const kids = Array.from(el.children);
      const idx = kids.findIndex(x=>x.innerText.trim()===val);
      if(idx>=0) el.scrollTop = idx * 44;
    };

    const onScroll = (which) => {
      const el = which==='a' ? wheelA.value : wheelB.value;
      if(!el) return;
      const index = Math.round(el.scrollTop / 44);
      const list = which==='a' ? listA.value : listB.value;
      if(list[index]){
        if(which==='a') wheel.a = list[index];
        else wheel.b = list[index];
      }
    };

    const saveWheel = () => {
      const idx = wheel.idx;
      const it = currentDay.value.items[idx];
      if(!it) return closeWheel();

      if(wheel.mode==='time'){
        it.time = `${wheel.a}:${wheel.b}`;
      }else if(wheel.mode==='stay'){
        it.stayMin = Number(wheel.a)*60 + Number(wheel.b);
      }else if(wheel.mode==='transit'){
        it.toNext = it.toNext || {mode:'drive', min:30};
        it.toNext.mode = wheel.transMode;
        it.toNext.min = Number(wheel.a)*60 + Number(wheel.b);
      }

      closeWheel();
      autoReschedule(currentDayIdx.value);
      saveAll();
    };

    // translate actions
    const swapLang = () => {
      const t = tr.from;
      tr.from = tr.to;
      tr.to = t;
      saveAll();
    };
    const openGoogleTranslate = () => {
      if(!tr.text) return alert('è«‹å…ˆè¼¸å…¥æ–‡å­—');
      const url = `https://translate.google.com/?sl=${encodeURIComponent(tr.from)}&tl=${encodeURIComponent(tr.to)}&text=${encodeURIComponent(tr.text)}&op=translate`;
      window.open(url, '_blank');
    };
    const copyText = async () => {
      try{
        await navigator.clipboard.writeText(tr.text||'');
        showToast('å·²è¤‡è£½');
      }catch(_){
        alert('è¤‡è£½å¤±æ•—ï¼ˆiOSé™åˆ¶ï¼‰ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½');
      }
    };

    // money
    const addExpense = () => {
      if(!newExpense.item || !newExpense.amount) return;
      expenses.value.push({
        id: crypto.randomUUID(),
        item: newExpense.item,
        amount: Number(newExpense.amount),
        dayIdx: Number(newExpense.dayIdx || 0)
      });
      newExpense.item = '';
      newExpense.amount = '';
      saveAll();
      showToast('å·²åŠ å…¥æ”¯å‡º');
    };
    const removeExpense = (i) => {
      expenses.value.splice(i,1);
      saveAll();
    };

    // FX (daily refresh)
    const todayKey = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };

    const refreshFX = async (force) => {
      try{
        const cache = JSON.parse(localStorage.getItem(FX_CACHE_KEY) || '{}');
        const key = todayKey();
        const curr = setup.currency;

        if(!force && cache && cache.date===key && cache.currency===curr && typeof cache.rate==='number'){
          exchangeRate.value = cache.rate;
          fxLastUpdated.value = cache.date;
          return;
        }

        // frankfurter: from=curr to=TWD
        const url = `https://api.frankfurter.app/latest?from=${encodeURIComponent(curr)}&to=TWD`;
        const res = await fetch(url);
        const j = await res.json();
        const rate = j?.rates?.TWD;
        if(typeof rate === 'number'){
          exchangeRate.value = rate;
          fxLastUpdated.value = key;
          localStorage.setItem(FX_CACHE_KEY, JSON.stringify({date:key, currency:curr, rate}));
          saveAll();
          showToast('åŒ¯ç‡å·²æ›´æ–°');
        }
      }catch(_){
        // keep manual
      }
    };

    // auto refresh when started & currency changes
    watch(() => setup.currency, () => {
      if(hasStarted.value) refreshFX(false);
    });

    // PWA SW register
    const registerSW = async () => {
      if(!('serviceWorker' in navigator)) { swStatus.value='ä¸æ”¯æ´'; return; }
      try{
        const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
        swStatus.value = 'å·²è¨»å†Š';
        reg.update?.();
      }catch(_){
        swStatus.value = 'è¨»å†Šå¤±æ•—';
      }
    };

    // on mounted
    onMounted(async () => {
      loadAll();
      await registerSW();
      if(hasStarted.value) refreshFX(false);
    });

    return {
      hasStarted, viewMode, currentDayIdx, setup, totalDays, days,
      searchQuery, suggestions, detectedCountry, isSearching,
      debounceSearch, selectLocation,
      initTrip, addDay, goBack,
      currentDay, categories,
      flights, currentDayFlights, addFlightSegment, openFlightEditor, removeFlight,
      addItem, removeItem,
      getTransIcon, transLabel,
      geocodeItem, autoGeocode,
      calcRoutes, openGoogleDirections,
      wheel, wheelA, wheelB, wheelTitle, listA, listB, openWheel, closeWheel, saveWheel, onScroll,
      minsToHM, fmtDate,
      langs, tr, quickPhrases, swapLang, openGoogleTranslate, copyText,
      expenses, newExpense, totalExpense, dailyTotals, addExpense, removeExpense,
      exchangeRate, fxLastUpdated, refreshFX,
      toast,
      swStatus, forceReload,
      saveAll
    };
  }
}).mount('#app');
</script>
</body>
</html>